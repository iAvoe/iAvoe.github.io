<!DOCTYPE html>
<html lang='zh-hans'>
	<head>
        <meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="initial-scale=1">
        <!-- Basic Bootstrap Javascript <script src="./files/bootstrap.min.js"></script> -->
        <!-- Bootstrap CSS <link rel="stylesheet" href="./files/bootstrap.css"> -->
        <!-- Bootstrap Icons CSS (remote)
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/span/bootstrap-icons.css" crossorigin="anonymous">
        -->
        <!-- Basic MathJax Javascript -->
        <script src="./files/mathJax3-tex-svg.js" defer></script>
        <!-- JavaScript Codes -->
        <script src="./files/tutorial.js" defer></script>
        <!-- Custom CSS Codes <link rel="stylesheet" href="./files/desktopContainer.css"> -->
        <link rel="stylesheet" href="./files/tutorial.css">
        
        <title>x265 教程 HTML 完整版</title>
	</head>
	<body class="text-gray-main">
        <div class="container-mobile rounded-9 border-main">
            <h1>x265 教程<span class="text-blue-emph"> HTML 完整版</span></h1>
            <p>欢迎阅读！若有什么不会的可以加群<a href='https://jq.qq.com/?_wv=1027&k=5YJFXyf'>691892901</a>。本教程仅算盲人摸象的业余分析，仅具备业余参考价值。入门先看 x264 视频压缩教程综合版，手头需要编码压制不妨搭配急用版教程。<span class="text-red-emph">点击图片即可更改桌面和移动端的适配排版</span>。</p>
            
            <h4 class="mb-0">ffmpeg，VapourSynth，avs2yuv 传递参数</h4>
            <pre><code>
ffmpeg -i &lt;源&gt; -an -f yuv4mpegpipe -strict unofficial - | x265 --y4m - --output
<span class="text-gray-note">ffmpeg -i &lt;源&gt; -an -f rawvideo	- | x265.exe --input-res &lt;宽x高&gt; --fps &lt;整/小/分数&gt; - --output</span>
<span class="text-blue-emph">-f</span>格式，<span class="text-blue-emph">-an</span>关音频，<span class="text-blue-emph">-strict unofficial</span>关格式限制，<span class="text-blue-emph">--y4m</span>对应"YUV for MPEG"，两个"-"是Unix pipe串流

VSpipe	源.vpy --y4m - | x265.exe - --y4m --output
avs2yuv	源.avs -csp&lt;色&gt; -depth&lt;深&gt; - | x265.exe --input-res &lt;宽x高&gt; --fps &lt;整/小/分数&gt; - --output
avs2pipemod 源.avs -y4mp | x265.exe --y4m - --output</code></pre>

            <h4 class="m-0">搜索 ffmpeg 支持的色度采样：</h4>
            <code>ffmpeg -pix_fmts | findstr &lt;或grep关键字&gt;</code>
            <h4 class="m-0">检查/选择色深，版本，编译：</h4>
            <code>x265.exe -V，-D &lt;8/10/12调整色深&gt;</code>
            <h4 class="m-0">多字体 + 艺术体 + 上下标 .ass 字幕渲染：</h4>
            <code>ffmpeg -filter_complex "ass='F\:/字幕.ass'"滤镜</code>
            <h4 class="m-0">Linux Bash，Mac Terminal，Windows CMD 报错导出：</h4>
            <pre><code>
x265.exe [命令行] 2>&1 | tee home\[用户名]\Desktop\报错.txt
x265.exe [命令行] 2>&1 | tee User\[用户名]\Desktop\报错.txt
x265.exe [命令行] 2> [桌面路径]\报错.txt</code></pre>

            <h2>分块</h2>
            <p>HEVC 中，帧下结构按面积大小分为<span class="text-blue-emph">帧 → 瓦 tile → 条带 slice → 条带分段 ss → ctu 树单元 → cu 单元</span>。</p>
            <p>cu，cb 由同帧的 ctu 经动态搜索 ME 与运动补偿 MC 隔离所得。其 U/unit 代表 YCbCr 整体块；B/block 则单指 Y，Cb 或 Cr 块，区分亮度色度。ipcm-cu 代表跳过 MEMC，直达环路滤波的「帧内编码 pcm 波形 cu」intra pulse code modulation cu，因为“块”是一串像素值的波形，只是用元数据“换行”到二维而已。</p>
            <div class="align-items-center">
                <img src="files/image1.png" alt="Coding Tree Unit" class="img-medium" >
                <p class="text-gray-side mt-0">图：Coding Tree Unit 以及其下 Coding Unit 的划分</p>
            </div>

            <h4 class="same-line">PU - 预测单元：</h4>
            <p class="same-line">Prediction unit 是编码完，用做参考源的块。支持 CU 上对称 Rectangle，非对称 Asymmetric 划分，以更好的隔离动静态。亮度与色度上的分裂法可以不同，小至 4x4 像素。</p>
            <div class="align-items-center">
                <img src="files/image2.png" alt="Prediction Unit" class="img-medium" >
                <p class="text-gray-side mt-0">图：pu 的 4 种对称 rectangular 和 4 种不对称 asymmetric 划分</p>
            </div>
            
            <h4 class="same-line">TU - 变换单元：</h4>
            <p class="same-line">Transforma unit 的划分与 CU 而非 PU 同步，实现变换和量化</p>
            <div class="align-items-center">
                <img src="files/image3.png" alt="Transform Unit" class="img-medium" >
            </div>

            <h4 class="same-line">AU - 存取单元：</h4>
            <p class="same-line">access unit，解码端用于启动解码播放的块，一般为 IDR-AU</p>

            <pre><code><b>--ctu</b> &lt;64/32/16，默认64&gt;
编码树单元最大大小。大则有损压缩效率高，速度慢。一般建议保持默认，除非片有类似jpeg边缘损失的老片设<span class="text-blue-emph">32</span>，分辨率特别小的老片设<span class="text-blue-emph">16</span>
<b>--min-cu-size</b> &lt;32/16，默认8&gt;
限制最小cu大小，简化计算步骤，因为使往后步骤pu，tu的划分也会更大。用多一点码率换取编码速度的参数。建议日常环境使用<span class="text-blue-emph">16</span>或快速编码环境使用<span class="text-blue-emph">32</span>
<b>--rect --amp</b> &lt;开关，默认关，受limit-modes限制，<span class="text-red-emph">amp需rect</span>&gt;
限制最小cu大小，简化计算步骤，因为使往后步骤pu，tu的划分也会更大。用多一点码率换取编码速度的参数。建议日常环境使用<span class="text-blue-emph">16</span>或快速编码环境使用<span class="text-blue-emph">32</span></code></pre>

            <h2>变换</h2>
            <div class="row">
                <div id="LR-UD-001" class="col-8">
                    <h4>一维傅里叶变换 1D Fourier Transform</h4>
                    <p>给出与原信号波形等高，从最长的频率周期开始不断缩窄（周期增加）并根据源信号调整相位的参考余弦。在参考余弦波变化的过程中，记下两条波形吻合度变化的曲线 - 不同波形周期的振幅，得频域信号。反过来将频域所对应的波形加回去就是逆变换。为将源波形中反相（上下颠倒）的余弦也考虑在内，所以计算过程含取立方转正。</p>
                    <p>
                        「不断缩窄的参考余弦」可用<span class="text-blue-math">\(\cos\left(\frac{2\pi}{T}\right)\)</span>表示，以及复数用<span class="text-blue-math">\(cos(x)+isin(x)\)</span>表示；相位可记为<span class="text-blue-math">\(\text{atan2}\left(\text{iFT}(x),\text{FT}(x)\right)\)</span>以及复数用<span class="text-blue-math">\(\sqrt{(FT(x)^2 + iFT(x)^2)}\)</span>，表示频域点的亮度和位移（二维变换下是旋角）。
                    </p>
                    <p>
                        <span class="text-blue-math">\(\text{atan2}(y,x)\)</span>
                        代表二轴坐标系统计一圈 360°（2π）的旋角，几何坐标系中同理的<span class="text-blue-math">\(\tan^{-1}\)</span>超过 180°（π）会归零而不用。详见<a href="https://www.desmos.com/calculator/qpnz9celzf">desmos 例 1</a>，<a href="https://www.desmos.com/calculator/ywxqicajbv">desmos 例 2</a>，<a href="https://www.youtube.com/watch?v=spUNpyF58BY">3b1b 视频科普</a>以及<a href="https://www.youtube.com/watch?v=tEzgtbnbXgQ">Computer Vision 公开课</a>。
                    </p>
                    <h4>二维傅里叶变换 2D-FT</h4>
                    <p>宽高上单拆出线来分别进行 1DFT，以双求和/双积分 ΣΣ/∫∫ 整合。在频域中相当于每个像素的变换结果相加或干涉。亮则振幅大，距中心远则频率高。强在可编辑性，可以消除打印喷头，抖动等均匀噪声。</p>
                </div>
                <img src="files/image4.png" alt="Fourier Transform Phenomenons" id="LR-UD-002" class="img-medium img-right col-4 mb-auto" >
                <div id="LR-UD-003" class="col-8">
                    <h4>二维离散余弦变换 2D Descrete Cosine Transform</h4>
                    <p>用预制的二维波形模具，穷举加减列出各波形格子的使用次数，比 2DFT 更快。</p>
                    <p class="text-gray-side mt-0">图：二维傅里叶变换的特性，背景特性以及可编辑性</p>
                </div>
                <img src="files/image5.png" alt="Fourier Transform Editing" id="LR-UD-004" class="img-medium img-right col-4 mb-auto" >
            </div>

            <pre class="m-0"><code><b>--limit-tu</b>&lt;整数0~4默认关，<span class="text-red-emph">需tu-intra/inter-depth大于1</span>&gt;
提前退出tu分块，以量化/残差编码质量为代价提速。<a href="https://forum.doom9.org/showthread.php?p=1963250#post1963250">tu大则易出现量化涂抹</a>，不利于暂停画质
    · <span class="text-blue-emph">1</span> 一般，画质编码，取分裂/跳过中花费最小的
    · <span class="text-blue-emph">2</span> 以同ctu内的首个tu分裂次数为上限
    · <span class="text-blue-emph">3</span> 快速编码取帧内帧间附近tu分裂平均次数为上限
    · <span class="text-blue-emph">4</span> 不推荐，将3作为未来tu的分裂上限，相比0+20%速度
<b>--rdpenalty</b>&lt;整数0~2，默认关，<span class="text-red-emph">需tu-intra-depth大于1</span>&gt;
与limit-tu相反，强制tu分块细化以增加算力损耗并降低量化涂抹。可理解为tu分块的下限，例如高limit-tu，高crf时设2，避免32x32tu量化效果太强画面糊掉
    · <span class="text-blue-emph">1</span> 提高率失真代价而减少32x32tu出现概率
    · <span class="text-blue-emph">2</span> 强制32x32tu分块
    · <span class="text-red-emph">32x32的帧内cu需tu-intra-depth 2</span>
    · <span class="text-red-emph">64x64帧内cu需tu-intra-depth 3</span>
<b>--tu-intra-depth --tu-inter-depth</b>&lt;整数1~4，默认1，<span class="text-blue-emph">配合limit-tu</span>&gt;
空间域tu分裂次数上限,默认只在cu基础上分裂一次。决定量化质量所以建议开高，建议一般情况设2，保画质设3~4
<b>--max-tu-size</b>&lt;32/16/8/4，默认32&gt;大tu使压缩高而慢，以及瑕疵检测能力越差。码率换时间加画质。编码已有边缘损失的老片可搭配<span class="text-blue-emph">ctu 32</span>与<span class="text-blue-emph">max-tu-size 16</span></code></pre>

            <h2>帧间 - 动态搜索</h2>
            <p>逐块于帧间找最小失真朝向 Direction of minimal distortion / DMD，组成一张张帧间矢量表。缺则参考帧与分块的建立就不甚理想，损失可能的压缩率或画质。</p>
            <div class="align-items-center">
                <img src="files/image6.png" alt="Jain&Jain Search" class="" >
                <p class="text-gray-side mt-0">图：传统的 Jain & Jain 十字搜索。</p>
                <img src="files/image7.png" alt="LDSP&SDSP Search" class="" >
                <p class="text-gray-side mt-0">图：大小菱搜索。x264/5 中，六边形搜索 me hex 将 LDSP 的上下左右斜 8 个外点减到 6 个，SDSP 的细化规则不变。</p>
                <img src="files/image8.png" alt="Uneven multi-hexagon Search" class="" >
                <p class="text-gray-side mt-0">图：umh 搜索。</p>
            </div>

            <pre><code><b>--analyze-src-pics</b>&lt;开关，默认关&gt;
允许动态搜索查找片源帧，耗时增加压缩
<b>--me</b>&lt;hex/umh/star/esa/full，推荐umh&gt;
搜索算法，umh平衡，star四角星搜索之后收益递减，sea是优化过的x264 esa穷举，但收益递减仍大
<b>--merange</b>&lt;整数，推荐4的倍数，<span class="text-red-emph">需me</span>&gt;
<span class="text-blue-emph">完全取决于ME算法和分辨率</span>，过大会因「找不到更好，找到也是错」而损失画质和压缩
    · 1920x1080下推荐<span class="text-blue-emph">48</span>左右
    · 3840x2160下推荐<span class="text-blue-emph">52</span>左右
    · me hex下设<span class="text-blue-emph">16</span>
    · me umh-star设<span class="text-blue-emph">≥32</span>
<b>--no-temporal-mvp</b>&lt;开关&gt;
关P-B条带的动态搜索，除直播外不推荐
<b>--hme-search</b>&lt;hex/umh/star/esa/full，<span class="text-red-emph">关me</span>&gt;
三份异分辨率原画分别查找宏观到微观的搜索动态信息
<b>--hme-range</b>&lt;三整数，<span class="text-red-emph">需hme-search</span>，推荐默认<span class="text-blue-emph">16,32,48</span>&gt;
对应1/16，¼和全分辨率三画面</code></pre>
            
            <h2>帧间 - 子像素运动补偿</h2>
            <p>动态预测 ME 除了与帧内编码后的帧做差（以便推演 P/B/I 帧，见 x264 教程）以外，还被动态补偿 MC 以「允动画之移，拦静画所变」的原理消除如噪点之类导致的动态信息误判，同时将帧间矢量表中动态矢量的精度提高到¼像素以修复「动态预测因精度低导致细节损失」的画面错误。</p>
            <p>大体上，补偿过程是用帧内编码所得的“粗加工 PU”与源视频对应的块做差，使用有限冲激响应滤镜 Finite impulse response (FIR) filter 放大。此处指 x264-6tap；x265-8tap，7tap 和 4tap 滤镜。放大后用 SATD 对准动态矢量，得“精加工 PU”。</p>
            <div class="row">
                <div id="LR-UD-005" class="col-8 align-items-center">
                    <table class="table-center">
                        <tr>
                            <th class="px-1">编码器</th>
                            <th class="px-1">平面 - 块类型</th>
                            <th class="px-1">范围精度</th>
                            <th class="px-1">插值方法</th>
                        </tr>
                        <tr class="t-light-gray">
                            <td class="px-1">x264 官方</td>
                            <td class="px-1">亮度 Y</td>
                            <td class="px-1">½ 像素（hpel）</td>
                            <td class="px-1">6 tap FIR</td>
                        </tr>
                        <tr>
                            <td class="px-1">x264 官方</td>
                            <td class="px-1">亮度 Y</td>
                            <td class="px-1">¼ 像素（qpel）</td>
                            <td class="px-1">双线性插值（Bi-lerp）</td>
                        </tr>
                        <tr class="t-light-gray">
                            <td class="px-1">x264 官方</td>
                            <td class="px-1">色度 C</td>
                            <td class="px-1">hpel+qpel</td>
                            <td class="px-1">上下左右加权平均</td>
                        </tr>
                        <tr>
                            <td class="px-1">x265 官方</td>
                            <td class="px-1">亮度 Y</td>
                            <td class="px-1">hpel+qpel</td>
                            <td class="px-1">上下左右加权平均</td>
                        </tr>
                        <tr class="t-light-gray">
                            <td class="px-1">x265 官方</td>
                            <td class="px-1">亮度 Y</td>
                            <td class="px-1">¼像素（qpel）</td>
                            <td class="px-1">两种 7tap FIR</td>
                        </tr>
                        <tr>
                            <td class="px-1">x265 官方</td>
                            <td class="px-1">色度 C</td>
                            <td class="px-1">hpel+qpel</td>
                            <td class="px-1">4tap FIR</td>
                        </tr>
                    </table>
                </div>
                <img src="files/image9.png" alt="hpel qpel interpolation" id="LR-UD-006" class="img-small img-right col-2 mb-auto" >
            </div>
            <p class="text-gray-side mt-0">表：x264/5 实现 h~qpel 插值计算（实现了浮点→整数变量的程序优化）</p>
            <p class="text-gray-side mt-0">图：此“子像素”特指是放大出的 half-pixel(hpel)½像素，及 quarter-pixel(qpel)¼像素。</p>
            
            <div class="align-items-center">
                <img src="files/image10.png" alt="7tap 8tap interpolation 1" class="img-medium" >
            </div>
            <p class="text-gray-side mt-0">图：Y 平面 FIR 插值和 subme 并行，调用 8²或 16²块的横/纵向参考源。若 subme 所得动态的：</p>
            <ul>
                <li class="text-gray-side">向量横分量==0: [d][n] 分别用 7tapα或β采样整像素 [A]</li>
                <li class="text-gray-side">向量横分量!=0: [f][q] 分别用 7tapα或β采样子像素 [b]</li>
                <li class="text-gray-side">向量纵分量==0: [a][c] 分别用 7tapα或β采样整像素 [A]</li>
                <li class="text-gray-side">向量纵分量!=0: [i][k] 用 8tap 分别采样子像素 [a][c]</li>
            </ul>
            <div class="align-items-center">
                <img src="files/image11.png" alt="7tap 8tap interpolation 2" class="img-medium" >
            </div>

            <pre><code><b>--subme</b>&lt;整数范围1~7，默认2&gt;
根据源帧率借下表判断。
注：x264的rdo选项和subme并用，所以与x265不通用；SATD算法见x264教程。</code></pre>
            <table class="align-items-center table-center text-smaller">
                <tr>
                    <th class="px-1">范围 - 开 RDO</th>
                    <th class="px-1">推荐</th>
                    <th class="px-1">hpel 迭代</th>
                    <th class="px-1">hpel 搜索</th>
                    <th class="px-1">qpel 迭代</th>
                    <th class="px-1">qpel 搜索</th>
                    <th class="px-1">统计法</th>
                </tr>
                <tr class="t-light-gray">
                    <td class="px-1">30fps</td>
                    <td class="text-blue-emph px-1">3</td>
                    <td class="px-1">二次</td>
                    <td class="px-1">四方向</td>
                    <td class="px-1">一次</td>
                    <td class="px-1">四方向</td>
                    <td class="px-1">SATD</td>
                </tr>
                <tr>
                    <td class="px-1">48fps</td>
                    <td class="text-blue-emph px-1">4</td>
                    <td class="px-1">二次</td>
                    <td class="px-1">四方向</td>
                    <td class="px-1">二次</td>
                    <td class="px-1">四方向</td>
                    <td class="px-1">SATD</td>
                </tr>
                <tr class="t-light-gray">
                    <td class="px-1">60fps</td>
                    <td class="text-blue-emph px-1">5</td>
                    <td class="px-1">一次</td>
                    <td class="px-1">八方向</td>
                    <td class="px-1">一次</td>
                    <td class="px-1">八方向</td>
                    <td class="px-1">SATD</td>
                </tr>
                <tr>
                    <td class="px-1">90fps</td>
                    <td class="text-blue-emph px-1">6</td>
                    <td class="px-1">二次</td>
                    <td class="px-1">八方向</td>
                    <td class="px-1">一次</td>
                    <td class="px-1">八方向</td>
                    <td class="px-1">SATD</td>
                </tr>
                <tr class="t-light-gray">
                    <td class="px-1">≥144fps</td>
                    <td class="text-blue-emph px-1">7</td>
                    <td class="px-1">二次</td>
                    <td class="px-1">八方向</td>
                    <td class="px-1">二次</td>
                    <td class="px-1">八方向</td>
                    <td class="px-1">SATD</td>
                </tr>
            </table>

            <h4>加权预测 Weighted Prediction</h4>
            <div class="row">
                <div id="LR-UD-007" class="col-10">
                    <p>解决淡入淡出 fade 过程中，部分 PU 因误参考，亮度变化不一的块失真问题；分为 P-B 条带用的显加权，和 B 条带用的隐加权。</p>
                    <ul class="text-gray-side">
                        <li>显 Explicit：原画和编码过的参考帧做差，差距越小权重越高</li>
                        <li>隐 Implicit：用参考帧距离做加权平均插值，距离越近权重越高</li>
                    </ul>
                </div>
                <img src="files/image12.png" alt="Implicit Weighted Prediction" id="LR-UD-008" class="img-small img-right col-2 mt-3 mb-auto" >

                <pre><code><b>--weightb</b>&lt;开关，默认关&gt;
启用B条带的隐加权预测。注意光线变化和淡入淡出在公开课，电脑录屏，低成本/旧动漫等片源中几乎不存在，这种情况下打开只会浪费性能
                </code></pre>
            </div>

            <h2>帧间 - 时域架网搜索</h2>
            <h4>一维小波变换 1D Wavelet Transform</h4>
            <p>让短波像拉链一样划过一维信号，时间轴上根据短波波形选择，将与源信号匹配的程度变化记为频域信息（如使用低频 - 高频 - 低频的对称波形拆出音频热度图），支持更换波形以提取特征（如特征采样式音频降噪滤镜）。解决了傅里叶变换只有空间频域，无法描述信号随时间变化过程的原生缺陷，缺点是分辨率低。</p>
            
            <h4>基于提升式小波变换的时域动态补偿 lifting-scheme temporal MC</h4>
            <div class="row">
                <div id="LR-UD-009" class="col-auto">
                    <p>类似于 crf/abr 模式推演量化值中以 a-b 帧之差做复杂度累计。此处是用以预测 b-c 帧的差，而<span class="text-blue-emph">预测对的更新到低频 L 带，差错的更新到（不再参与下轮预测）的高频 H 带</span>，得 0-1-2，2-3-4，4-5-6 等（prediction）帧以及其 H 带（update）构成第 0 层</p>
                    <p>继续在 L<sub>1</sub>→L<sub>n</sub> 的 1 层向右迭代，分离出所有的 L，H 带，如此实现迭代 n 次即分离 2<sup>n</sup> 帧动静态，以及所有的预测与补偿，故不像传统动态搜索一样受缩放性 scalability（分辨率 vs 搜索范围）限制。是 Scalable Video Codec - SVC 编码的核心算法之一。</p>
                    <p>迭代后的高低频用 LL<sub>1</sub> LL<sub>2</sub> LH<sub>1</sub> LH<sub>2</sub> 表示低到高频的顺序，字母位数代表迭代次数。</p>
                </div>
                <img src="files/image13.png" alt="Lifting Scheme Temporal Motion Compensation" id="LR-UD-010" class="img-right col-auto mb-auto" >
            </div>

            <h4>高斯模糊 Gaussian blur</h4>
            <p>利用正态分布函数面积不变的特性，通过设定偏差程度 σ 决定正态分布钟型线的梯度：σ 大则钟扁——滤镜中心分到的权重/面积越被更多分到权/面积的旁像素冲淡模糊掉，设计行业常用。见<a href="https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A">维基百科</a>和<a href="https://www.desmos.com/calculator/jxzs8fz9qr">Desmos 互动例</a>。2D 高斯模糊写作：<span class="text-blue-math">
                $${\displaystyle G(x,y)={\frac {1}{2\pi \sigma ^{2}}}e^{-{\frac {x^{2}+y^{2}}{2\sigma ^{2}}}}}$$
            </span></p>
            <h4>中值滤镜 Median filter</h4>
            <p>和卷积滤镜一样用 n×n 的滤镜格子逐像素扫图，区别在于滤镜中心会被替换为旁像素的中值。如此一来在扫描窗口任意两端几乎一致的像素值会被识别为线段或边缘，中间的像素值会被同化，而平面上的噪点/颗粒就会被抹除，生成仅有平/斜面和完整线条边缘的“模糊”结果。见<a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%80%BC%E6%BB%A4%E6%B3%A2%E5%99%A8">维基百科</a>。</p>
            <h4>双边滤镜 Bilateral filter</h4>
            <p>将中值滤镜输出作为（2D）高斯模糊的权重蒙版（通过矩阵点除实现动态干涉滤镜强度）；因此平面/斜面/线条本身会决定高斯模糊正态分布钟在对应位置被保留/干涉/隔断的程度</p>
            <img src="files/image14.png" alt="Bilateral Filter" class="" >

            <pre><code><b>--mcstf</b>&lt;开关，默认关，<span class="text-red-emph">会关多线程</span>&gt;
时域动态补偿滤镜mctf搭配双阈滤镜的自动降噪，理论上提高细节保真。关多线程会大幅削弱性能</code></pre>

            <h2>溯块向量搜索</h2>
            <p>与帧内编码并行给动态搜索提供溯块向量（cu 帧内/帧间朝向以及大小）的步骤。由于移动的物件会跨越多个 PU，所以将涉及同个移动物件的 PB 合到一起就能冗余一群 PB 的动态向量。x264/5 用 <span class="text-blue-emph">--ref</span> 参数于时域上划区，逐 PU 创建 L<sub>0</sub> 和 L<sub>1</sub> 左右两排参考列表。x265 在 x264 <span class="text-blue-emph">--direct auto</span> 的基础上添加了 AMVP 与 Merge mode 两个方案</p>

            <h4>高级动态向量搜索 Advanced Motion Vector Prediction</h4>
            <ol class="mt-0">
                <li>在帧内看当前 PU 左下的邻 PU，优先匹配向量往帧内指的邻 PU</li>
                <li>参考向量指向其它帧的临 PU；并等比缩放，对齐到邻 PU 已按帧间差异对齐好的向量</li>
                <li>若以上步骤没找到参选向量，就把同样的步骤于当前 PU 右上角进行一次</li>
                <li>若应了如早批 PU 刚开始算，找不到参选向量的情况下就直接从时域搜索：<ul>
                    <li class="text-gray-side">照帧间参考图像变化的内容差异做缩放调整，从右下角的相邻 PU 找参选</li>
                </ul></li>
                <li>若仍不可用，就找当前 PU 中心位置的其它同位 PU；若最后没凑不齐两个参选向量，代入 v=0,0</li>
            </ol>
            <div class="row">
                <h4>并和搜索模式 Merge Mode</h4>
                <p id="LR-UD-011" class="col-8">然后用相对简单含糊算法接手剩余块的向量：从帧间，帧内凑五个参选块 candidate，两个备选，少服从多地并和动态向量。（该模式会跳过 PU 的边缘及当前向量以提速）</p>
                <img src="files/image15.png" alt="HEVC Merge Mode" id="LR-UD-012" class="img-medium img-right col-4 mb-auto" >
            </div>

            <pre><code><b>--max-merge</b>&lt;整数0~5，默认2&gt;
重设merge mode被选参考块的数量，时间换质量。建议高压编码设<span class="text-blue-emph">4</span>，其它可设<span class="text-blue-emph">2，3</span>
<b>--early-skip</b>&lt;开关，默认关&gt;
先查2nx2n merge被选块，找不到就跳过AMVP以提速</code></pre>

            <h2>初始化-Lookahead</h2>
            <p>最先运行，给视频帧分段并最终整合成 GOP 内树叉状的参考结构，设关键帧并递给下一步帧内编码。一来冗余，二来防止参考错误蔓延（否则丢一个网络数据包会导致长时间绿屏花屏）。过程见<a href="https://www.nazorip.site/archives/63">x264 教程</a></p>

            <pre><code><b>--scenecut</b>&lt;整数，不推荐用&gt;
Lookahead中两帧差距达到该参数值则触发转场
<b>--hist-scenecut</b>&lt;开关，默认关，会关scenecut，<span class="text-blue-emph">10与12bit源可能会导致崩溃</span>，推荐8bit下用&gt;
亮度平面边缘+颜色直方图SAD阈值触发转场。x265 v3.5+69后编码彩色视频，尤其<a href="https://forum.doom9.org/showthread.php?p=1978502">HDR源中超越scenecut精度~20%</a>，降低了正误判（设I帧，closed-gop下帧间冗余效益降低）和负误判（不设I帧，分为多个带I块的P帧，帧内编码效益降低），因此除黑白视频外推荐。缺点是超过8bit后不稳定，且理论上不应对画质/压缩率有太大影响
注：hist-threshold参数于x265 v3.5+69被删
<b>--rc-lookahead</b>&lt;帧数量，范围1~250，推荐keyint÷2&gt;
指定cutree的检索帧数，通常设在帧率的2.5~3倍。高则占用内存增加延迟，低则降低压缩率和平均画质。
注：cutree会自动选择--rc-lookahead和max(--keyint,max(--vbv-maxrate,--bitrate)÷--vbv-bufsize×fps)中最小的值作为检索帧数
<b>--no-cutree</b>&lt;开关&gt;
关闭少见CTU量化增强偏移。可能只有近无损，crf小于16才用的到</code></pre>

            <h4 class="same-line">P/B 帧推演-Viterbi 最短路径算法</h4><p class="same-line">：见<a href="https://www.nazorip.site/archives/63">x264 教程</a></p>

            <pre><code><b>--b-adapt</b>&lt;整数0~2，推荐<span class="text-blue-emph">2</span>&gt;
<span class="text-blue-emph">0</span>停用，<span class="text-blue-emph">1</span>快速算法，因当今设备算力够高所以一律<span class="text-blue-emph">2</span>
<b>--bframe-bias</b>&lt;整数-90~100，推荐默认&gt;
设立B帧判定偏移，增大的同时搭配低pbratio可增加B帧数量，用负值搭配高pbratio可以减少B帧数量</code></pre>

            <h4>网络抽象层单元 - 参数集</h4>
            <p>Network abstraction layer unit 中含解码配置 profile，level 的数据包。x264 中的视频帧数即 <span class="text-blue-math"><code>sps->vui.i_num_units_in_tick</code></span> 或 <span class="text-blue-math"><code>sps->vui.i_time_scale÷2</code></span> 所得（÷1 则为分行交错视频）</p>
            <ul class="text-gray-side">
                <li>视频参数集 Video parameter set</li>
                <li>序列参数集 Sequence parameter set-——分枝 - 负责播放时间戳，显加权与其它特定解码要求</li>
                <li>图参数集 Picture parameter set————分枝 - 负责解码信息</li>
                <li>条带段 Slice segment—————————分枝 - 负责防止 ctu 中的错误传播到整个条带，ctu 以上最小的单位</li>
            </ul>

            <pre><code><b>--opt-qp-pps --opt-ref-list-length-pps</b>&lt;开关，默认关，已知兼容性问题&gt;
据上个GOP改动当前PPS中默认的qp/ref参数值，从而整体上优化视频数据结构。尽管符合HEVC标准，但部分解码端，包括视频网站都不这么想
注：兼容性问题为<a href="https://forum.doom9.org/showthread.php?p=1978837">应该用hev1而非hvc1封装进ISO-BMFF</a>
<b>--repeat-headers</b>&lt;开关，默认关&gt;
在流未封装的情况下提供SPS，PPS等信息，正常播放HEVC源码
注：封装文件的科普<a href="https://www.nazorip.site/archives/63">见x264教程</a></code></pre>

            <h4>流媒体缓冲缓存</h4>
            <p>视音频在开始播放前预先加载到内存的一段缓冲区。只要存入缓冲区的波动不大就能保证播放在很多条件下的流畅性。视频流则以确保网络设施正常和控制视频码率本身做到流畅</p>

            <h4>Videl Buffer Verifier - 基于缓冲条件的量化控制</h4>
            <p>手动指定网络/设备下所允许的缓冲速度 kbps 以加大量化压缩，控制 CRF/ABR 模式。与 CRF 一并使用时叫可变码率 Variable Bitrate / VBR 模式。使用时应注意 VBV 完全不理画质，而卡顿的原因可能仅仅是因为 app 客户端的缓存设太小了。</p>

            <pre><code><b>--vbv-bufsize</b>&lt;整数kbps，默认关=0，<span class="text-red-emph">小于maxrate</span>&gt;
编码器解出原画后，最多可占的缓存每秒。bufsize÷maxrate=播放时解码出每gop原画帧数的缓冲用时（秒）。<span class="text-blue-emph">值的大小相对于编完GOP平均大小。编码器用到是因为模式决策要解码出每个压缩步骤中的内容与原画作对比用</span>
<b>--vbv-maxrate</b>&lt;整数kbps，默认关0&gt;
峰值红线。用「出缓帧码率-入缓帧码率必≤maxrate"」限制编码器在GOP码率超bufsize，即缓存跑满时压缩超载帧（提高qp值+强降噪至码率合规为止）。当入缓帧较小时，出缓帧就算超maxrate也会因缓存有空而不被压缩。所以有四种状态，需经验判断：
    · 大：GOP大小=bufsize=2×maxrate，超限后等缓存满再压，避开多数涨落，适合限平均率的串流
    · 小：GOP大小=bufsize=1×maxrate，超码率限制后直接压，避开部分涨落，适合限峰值的串流
    · 超：GOP大小&lt;bufsize=1~2×maxrate，超码率限制后直接压，但因视频小/crf大所以没啥作用
    · 欠：GOP大小&gt;bufsize=1~2×maxrate，超码率限制后直接压，但因视频大/crf小所以全都糊掉
    · 由于gop多样，4种状态常会出现在同一视频中。buf/max实际控制了这些状态的出现概率
<b>--crf-max</b>&lt;整数0~51&gt;
防止vbv把crf拉太高，但会导致码率失控</code></pre>

            <h4>关键帧</h4>
            <h5>刷新解码帧 Instant decoder refresh IDR</h5>
            <ul class="text-gray-side text-smaller">
                <li>自身储存完整图片，但同时还负责 GOP 间划界分段，播完令解码器清理前 GOP 缓存的大写 I 帧</li>
                <li>清缓存是为了防止参考/内存错误传播，错误可能源自硬件/软件/网络/干扰等</li>
            </ul>
            <h5>随机访问点 Random access point RAP</h5>
            <ul class="text-gray-side text-smaller">
                <li>“访问”代表播出画面前获取数据的过程</li>
                <li>“任意”代表拖进度条，打开直播，使进度条上任意一点都要正常解码的目的，增加码率提升体验</li>
            </ul>
            <h5>CRA/DRA净/脏任意访问 clean/dirty random access</h5>
            <ul class="text-gray-side text-smaller">
                <li>Open-gop 状态下指定包括 GOP 间划界，GOP 内帧间参考，自身储存完整图片的 i 帧</li>
                <li>附近的 rasl/radl 帧与之相对应</li>
                <li>「脏」指一组含 i 块的 P 帧，需要全部解码才能重建出 i 帧。压缩更高但相比 i 帧的解码更容易糊（脏）</li>
            </ul>
            <h5>断链访问帧 Broken link access BLA</h5>
            <ul class="text-gray-side text-smaller">
                <li class="mt-0">open-gop 间划界，访问不相关/不相连 GOP 的特殊 CRA 帧。用于不暂停播放的分辨率切换</li>
            </ul>

            <pre><code><b>no-open-gop</b>&lt;开关，默认关，建议开&gt;
不用cra/bla，增加码率增加兼容性，适合长GOP策略
<b>--keyint</b>&lt;整数，默认25&gt;
判断新发现的转场距上个IDR帧的距离是否短于此值。有两种设定逻辑，而它们给出的画质都一样：
    · 设5或更高，省了设立一些IDR帧拖慢速度。快速编码/直播环境直接设=keyint
    · 设1来增加IDR帧，一帧被判做转场本来就意味着前后溯块的价值不高。而P/B帧内可以放置I宏块，x264/5倾向插P/B帧。好处是进度条落点在激烈的动作场面更密集
<b>--fades</b>&lt;开关，默认关&gt;
找流中的虚实渐变fade-in，给小到帧间条带，大到整个帧间范围改用I条带，并根据渐变后最亮的帧重设码率控制历史记录，解决转场致模糊的问题
注：与weightb殊路同归但效果更强，增加码率更多</code></pre>

            <h4>参考帧</h4>
            <h5>RASL 任访略前导，RADL 任仿解前导 random access skipping/decoding lead</h5>
            <ul class="text-gray-side text-smaller">
                <li>打开直播或用户拖动进度条落在 CRA 附近，找不到 I 帧时指定应该解码 decode 还是略过 skip 的标签 P 帧</li>
            </ul>

            <pre><code><b>--ref</b>&lt;整数1~16，推荐<span class="text-blue-math">fps÷100+3.4</span>&gt;
向量溯块前后帧数半径，一图流设<span class="text-blue-emph">1</span>。要在能溯全所有块的情况下降低参考面积，所以一般设<span class="text-blue-emph">3</span>就不管了
<b>--radl</b>&lt;整数默认0，小于连续B帧，推荐2~3&gt;
原理见上
<b>--ipratio --pbratio</b>&lt;浮点,默认1.4 1.3&gt;
P帧比IDR/I，及B/b帧相比P帧的量化值递增。B帧双向参考能从更多帧中找到参考源，因此量化强度理应最高：
    · 真人录像片源中保持默认
    · 动漫片源中连续长B帧出现几率增多，有时会找不到合适的参考源导致画质损失，用<span class="text-blue-emph">1.2</span>或更小分配一定码率
    · 可据比例换算帧类型的qp，如<span class="text-blue-emph">I-qp17</span>，<span class="text-blue-emph">P-qp20</span>，<span class="text-blue-emph">B-qp22</span>即<span class="text-blue-emph">--qp/crf 17 --ipratio 1.1765 --pbratio 1.1</span>
<b>--bframes</b>&lt;整数0~16&gt;
最多可连续插入的B帧数量：
    · 一般录像/录屏快速，以及视频剪辑素材设<span class="text-blue-emph">3~6</span>以防止录制和剪辑的解码算力要求过高
    · 电影片源快速设<span class="text-blue-emph">8</span>左右
    · 低成本动画片源，或播放设备配置或硬解兼容高的话可设在<span class="text-blue-emph">13</span>左右
注：bframes大于8，同时keyint大于250会大增内存占用，但也取决于视频分辨率</code></pre>

            <h2>帧内编码</h2>
            <div class="row">
                <div id="LR-UD-013" class="col-8">
                    <p>组成参考源（I 帧）+ 参考帧的帧间结构后，数据会集中到 I 帧/ I 块上。故先使用单图无损压缩——补偿参考源，平滑（3-tap/ss），和编码 PB（趋平/夹角/DC）三步。补偿解决 PB 位于边角，或等不到其它 CB 编码完成而缺失的参考源；平滑预处理即根据情况，选择 3-tap FIR 或强力平滑滤镜，卷积插值出「纯预测 PU」</p>
                    <p>以下图预测块 C 为例：缺编码块 B 处的参考源就用编码块 A 的最右存在参考源做副本，并如法炮制编码块 D 补充 A-B 两块参考源的逻辑；EDAB 四编码块皆缺，则拿编码块 F 的顶部参考源替代；否则参考源皆填像素中值</p>
                    <p class="text-gray-side mt-0">图：补充参考源的检查顺序。</p>
                </div>
                <img src="files/image16.png" alt="HEVC Merge Mode" id="LR-UD-014" class="img-medium img-right col-4 mb-auto" >
    
                <div id="LR-UD-015" class="col-8">
                    <h4>强力平滑滤镜的启用条件</h4>
                    <ol>
                        <li>预测块 C 的大小小于 32x32</li>
                        <li>底 - 中 - 顶，及左 - 中 - 右三个纵/横向参考源两两差之和小于视频位深，如 8bit 下为 8</li>
                        <li>非 DC，非平行（夹角 10），非垂直（夹角 26）的帧内编码模式</li>
                    </ol>
                    <p class="text-gray-side mt-0">图：强力平滑滤镜的启用条件。</p>
                </div>
                <img src="files/image17.png" alt="Strong Intra Smoothing Condition" id="LR-UD-016" class="img-medium img-right col-4 mb-auto" >
                
                <div id="LR-UD-017" class="col-8">
                    <h4>强力平滑滤镜 Strong intra smoothing</h4>
                    <ol>
                        <li>从横 - 纵向两个参考点直接线性插值 lerp 出所有参考点，以及所对应的预测像素 p</li>
                        <li>缓解了色带问题</li>
                    </ol>
                    <p class="text-gray-side mt-0">图：强力平滑滤镜。</p>
                </div>
                <img src="files/image18.png" alt="Strong Intra Smoothing Filter" id="LR-UD-018" class="img-medium img-right col-4 mb-auto" >
                
                <div id="LR-UD-019" class="col-8">
                    <h4>3-tap 有限冲击响应 Finite Impulse Reponse 滤镜</h4>
                    <p>用横向<span class="text-blue-math">\(t(x)\)</span>与纵向<span class="text-blue-math">\(l(y)\)</span>各 3 像素加权平均得预测像素 p，按卷积顺序轮询得到 PU</p>
                    <p class="text-gray-side mt-0">图：3tap FIR 滤镜。</p>
                    <p>预处理后，用趋平，夹角，或 DC 模式初步编码 PB 到 CB。</p>
                </div>
                <img src="files/image19.png" alt="3tap FIR Filter" id="LR-UD-020" class="img-small img-right col-2 mb-auto" >

                <h4>趋平模式 Planarr</h4>
                <div id="LR-UD-021" class="col-8">
                    <p>
                        用双线性插值 Bi-lerp，让左 - 上过渡为右 - 下平面。由
                        <span class="text-blue-math">
                            <span class="text-blue-pure">底β</span>
                            ×
                            <span class="text-blue-pure">高α</span>
                            +
                            <span class="text-red-pure">底α</span>
                            ×
                            <span class="text-red-pure">高β</span>
                            =
                            <span class="text-green-pure">h</span>
                            ×
                            <span class="text-green-pure">底γ</span>
                        </span>
                        的关系从<span class="text-blue-math">\(l(y)\)</span>得过渡线<span class="text-blue-math">\(h\)</span>，再做<span class="text-blue-math">\(t(x)\)</span>得过渡线<span class="text-blue-math">\(v\)</span>，而所有过渡线连起来，每个预测的像素点取平均就完成了趋平插值。
                    </p>
                    <p class="text-gray-side mt-0">图：得到一个平均预测像素 p(x,y) 的过程。</p>
                </div>
                <img src="files/image20.png" alt="Planar Intra Coding Mode" id="LR-UD-022" class="img-medium img-right col-4 mb-auto" >

                <h4>夹角模式 Direct（35 种）</h4>
                <div id="LR-UD-023" class="col-10">
                    <p>将渐变（斜面）PB 无损压缩为编码块 CB 中全部画面与参考源共角的夹角<span class="text-blue-math">\(\theta\)</span>拓补结构。通过穷举所有<span class="text-blue-math">\(p(x,y)\)</span>的夹角以尝试对齐上方横向参考源<span class="text-blue-math">\(t(x)\)</span>，或左侧纵向参考源<span class="text-blue-math">\(l(y)\)</span>中差异最小的点<span class="text-blue-math">\(t(x\pm n)\)</span>或纵向的<span class="text-blue-math">\(l(y\pm n)\)</span>构成直角三角。用三角函数<span class="text-blue-math">\(\frac{opp}{adj} = \tan\theta\)</span>得预测像素<span class="text-blue-math">\(p\)</span>的夹角<span class="text-blue-math">\(\theta\)</span>
                </div>

                <img src="files/image21.png" alt="Directional Coding Modes" id="LR-UD-024" class="img-small img-right col-2 mb-auto" >
                <div class="align-items-center">
                    <img src="files/image22.png" alt="Directional Angle Algebra" class="img-small" >
                    <p class="text-gray-side mt-0">图：大体的精确夹角测算。见<a href="https://www.elecard.com/page/spatial_intra_prediction_in_hevc">Elecard 参考书</a></p>
                </div>
            </div>

            <h4 class="same-line">量化</h4><p class="same-line">：见<a href="https://www.nazorip.site/archives/63">x264 教程</a></p>
            <h2>率控制 - 算出量化值 Quantization Parameter</h2>
            <p>人眼对明暗变化与画面细节程度的感知呈对数㏒状，分别奠定了显示器的伽马曲线映射，以及量化值 qp（x 轴）到强度 qScale（y 轴）的强度映射。<span class="text-gray-side">图：量化值 qp 到 qScale 的映射，见<a href="https://www.desmos.com/calculator/vernjiiphf">desmos 互动例</a></span>；伽马矫正的科普见<a href="https://www.nazorip.site/archives/63">x264 教程</a>，<a href="https://www.artleds.com/blog/introduction-to-gamma-curves-and-gamma-correction-in-led-pixel-tapes-application">ArtLEDs 科普</a>。</p>
            <img src="files/image23.png" alt="Logrithm QP to qScale" class="" >
            <p>由于当前帧此时还未编码（码率未知），故寻已编码前帧的量化失真程度（越高则后帧理应越复杂），做推演复杂度/模糊复杂度。CRF 越高则除进推演复杂度的分母越大/ABR 越低则分子越小，得到的推演复杂度越低，推演出的 qp 就越高。<span class="text-gray-side">表：分别以 [L<sub>-1</sub>] 和 [L] 表示上帧和当前帧</span></p>
            
            <div class="mt-3 align-items-center">
                <table class="table-center text-smaller">
                    <tr class="border-bottom">
                        <th class="t-light-gray px-1">
                            cplxSum<span class="text-blue-math">$$\frac{cplxSum\lbrack L_{-1}\rbrack}{2} + SATD\lbrack L_{-1}\rbrack$$</span>
                        </th>
                        <td>一直于当前与上帧帧间做差并累积，总差异先减半一次再添加新的差异程度</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="t-light-gray px-1">
                            cplxCount<span class="text-blue-math">$$\frac{cplxSum\lbrack L_{-1}\rbrack}{2} + 1$$</span>
                        </th>
                        <td>初始为零，用于逐帧加权 cplxBlur 的帧数计。÷2 与 cplxSum 同步。加权逻辑时越往后参考冗余理应越多的规律</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="t-light-gray px-1">
                            cplxBlur<span class="text-blue-math">$$\frac{cplxSum}{cplxCount}$$</span>
                        </th>
                        <td>模糊复杂度。据帧所处推演加权的新 SATD。近似 100% 则当前帧复杂度推高（涨势复杂度）可扭转 cplxCount 默认的跌势</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="t-light-gray px-1">
                            qScale<span class="text-blue-math">$$0.85 \times 2^{\frac{qp-12}{6}}$$</span>
                        </th>
                        <td>GOP 内累计的直线化 qp，或 rdoq 的拉格朗日值 λ。已编码帧的 qp 转 qScale，便于其它参数修改更新</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="t-light-gray px-1">
                            ABR_rate_factor<span class="text-blue-math">$$\frac{target\_rate\_window}{\text{cplxSum}}$$</span>
                        </th>
                        <td>GOP 初始值，ABR 下的 qScale（rdoqλ）转 qp</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="t-light-gray px-1">
                            ABR_qScaleNew<span class="text-blue-math">$$\frac{qscale \times \text{overflow}}{ABR\_rate\_factor}$$</span>
                        </th>
                        <td>据 ABR 控制更新一遍 qScale（rdoqλ）</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="t-light-gray px-1">
                            cplxBase<span class="text-blue-math">$$ctu\_count \times (bframe?120:80)$$</span>
                        </th>
                        <td>常数/恒定值。CRF 模式默认的复杂度。若用 B 帧编码则 CTU 或宏块数量×120，否则×80</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="t-light-gray px-1">
                            CRF_rate_factor<span class="text-blue-math">$$\frac{cplxBase^{1-qcomp}}{qScale \times (crf + cutree + bframe\_offset)}$$</span>
                        </th>
                        <td>GOP 内累计，经 cutree，B 帧偏移乘进 qScale 后得 1-qcomp 与 CRF_qScale 对齐（仅 cplxBase，cplxBlur 运算）</td>
                    </tr>
                    <tr class=" border-bottom">
                        <th class="t-light-gray px-1">
                            CRF_qScaleNew<span class="text-blue-math">$$\frac{cplxBlur^{1-qcomp}}{CRF\_rate\_factor}$$</span>
                        </th>
                        <td>据 crf_rate_factor 更新当前帧的 qScale（rdoqλ）</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="t-light-gray px-1">
                            qp<span class="text-blue-math">$$6\log_{2}{\frac{qscale\_ new}{0.85} + 12}$$</span>
                        </th>
                        <td>qScale（rdoqλ）经调整后得到当前帧的量化值 qp。各 qp 对应一套 DCT 变换量化矩阵。qp→qStep 见<a href="https://www.nazorip.site/archives/63">x264 教程</a></td>
                    </tr>
                </table>
            </div>

            <p>经此实现了帧内画面复杂则 qp 低，简则高；同时据用户设定的（对数）强度的动态变化。这种质量判断只有两帧而不宏观，所以引出了各种各样的优化步骤，如 mb/cutree，rdoq 等。</p>

            <h4>CRF 上层模式</h4>
            <pre><code><b>--crf</b>&lt;浮点范围0~51，默认23&gt;
据cplxBlur，cutree，B帧偏移给每帧分配各自 qp 的固定目标质量模式，或简称质量呼应码率模式，统称crf。素材级画质设在16~18，收藏~高压画质设在19~20.5，YouTube是23。由于动画和录像的内容差距，动画比录像要给低点。理论上crf高=量化损失多→率失真优化慢；但测试出来是crf+2则4k 4:4:4 12bit会快~0.5fps
<b>--qpmin</b>&lt;整数0~51&gt;
由于画质和优质参考帧呈正比，所以仅高压环境建议设最高14
<b>--qpmax</b>&lt;整数0~51&gt;
在要用到颜色键，颜色替换等需要清晰物件边缘的滤镜时，可以设<span class="text-blue-emph">26</span>防止录屏时物件的边缘被压缩的太厉害，其他情况永远不如关cu/mbtree
<b>--qcomp</b>&lt;开关，tune grain时开启&gt;
通过cplxBlur抑制qp判断被噪声带偏，胶片颗粒片源用
<b>--cplxblur</b>&lt;浮点0~100，默认20&gt;
第-1帧不存在，无法算出第0帧的cplxBlur所以直接指定</code></pre>

            <h4>ABR 上层模式</h4>
            <p>编码器自行判断量化程度，尝试压缩到用户定义的平均码率 average bitrate 上，速度最快</p>
            <pre><code><b>--bitrate</b>&lt;整数kbps&gt;
平均码率。若视频易压缩且码率给高，就会得到码率比设定的片子；反过来低了会不照顾画质强行提高量化，使码率达标。如果给太低则会得到码率不达标，同时画质差的片子。平均码率模式，除2pass分隔，一般推流用的"码率选项"就是这个参数，速度快但同时妥协了压缩</code></pre>

            <h4>SBRC 下层模式 - 可搭配 CRF/ABR/CRF-VBR/ABR-VBR</h4>
            <p>分段式率控制 Segment based rate control，实现 DASH，M3U8 串流（视频平台）用。</p>
            <pre><code><b>--sbrc</b>&lt;开关，<span class="text-red-emph">需min-keyint=keyint</span>，<span class="text-red-emph">no-open-gop</span>&gt;
由于提高了初始CRF值的利用率，所以建议搭配--cplxblur=crf使用</code></pre>

            <h4>CQP 双层模式</h4>
            <pre><code><b>--qp</b>&lt;整数0~69，<span class="text-red-emph">禁用crf/abr+模式决策+率失真优化</span>&gt;
直接设定全局量化强度。影响其后的综合画质下降或码率暴涨，所以除非yuv4:4:4情况下有既定目的，都不建议</code></pre>

            <h4>2pass-ABR 双层模式</h4>
            <p>先用 CRF 模式分析整个视频总结可压缩信息，后根据 ABR 模式的码率限制统一分配量化值。有 pass 2 给特别高的平均码率，输出最小损失的最小体积近无损模式，以及 pass2 给码率硬限的全局整体压缩模式</p>
            <pre><code><b>--pass 1</b>&lt;挡位，导出stats数据文件&gt;；
    <b>--pass 2</b>&lt;挡位，导入stats数据文件&gt;；
    <b>--stats</b>&lt;路径，默认在x264/5目录下&gt;
<b>--slow-firstpass</b>&lt;开关&gt;
pass1 里不用 fast-intra no-rect no-amp early-skip ref 1 max-merge 1 me dia subme 2 rd 2，或者手动覆盖掉</code></pre>

            <h4>Analysis-2pass-ABR 双层模式</h4>
            <p>于普通 2pass 基础上让 pass1 的帧内帧间分析结果给到 pass2。</p>
            <pre><code><b>--analysis-save --analysis-load</b>&lt;路径&gt;
指定导入/出analysis信息文件的路径，文件名
<b>--analysis-save-reuse-level --analysis-load-reuse-level</b>&lt;整数1~10，默认5&gt;
指定analysis-save和load的信息量，配合pass1的动态搜索，帧内搜索，参考帧等参数。推荐8
    · <span class="text-blue-emph">1</span>储存lookahead信息
    · <span class="text-blue-emph">2==4</span>同时储存帧内/帧间向量格式+参考信息
    · <span class="text-blue-emph">5==6</span>加rect/amp分块信息
    · <span class="text-blue-emph">7</span>加8x8cu分块优化信息
    · <span class="text-blue-emph">8==9</span>加完整8x8cu分块信息
    · <span class="text-blue-emph">10</span>加所有cu分析信息
<b>--dynamic-refine</b>&lt;开关，默认关&gt;
自动调整refine-inter，x265官方建议搭配refine-intra 4用，相比手动设定提高了压缩
<b>--refine-inter</b>&lt;整数0~3，默认0&gt;
限制帧间块的向量格式，<span class="text-blue-emph">取决于pass1分析结果是否可信，如pass 1只跑了快速搜索的情况</span>
    · <span class="text-blue-emph">0</span>完全遵从pass1的分块深度和向量格式
    · <span class="text-blue-emph">1</span>分析所有pass2中与pass1相同分块的向量格式，除2pass中比1pass更大的分块
    · <span class="text-blue-emph">2</span>一旦找出最佳的动态向量格式就应用于全部的块，2Nx2N块的rect/amp分块全部遵从pass1，仅对merge和2Nx2N划分的块的动态向量信息进行分析
    · <span class="text-blue-emph">3</span>保持使用pass1的分块程度，仍然搜索向量格式
<b>--refine-intra</b>&lt;整数0~3，默认0&gt;
限制帧间块的向量格式，<span class="text-blue-emph">取决于pass1分析结果是否可信，如pass 1只跑了快速搜索的情况</span>
    · <span class="text-blue-emph">0~2</span>同上
    · <span class="text-blue-emph">3</span>保持使用pass1的分块程度，但优化动态向量
    · <span class="text-blue-emph">4</span>pass1丢弃不用
<b>--refine-mv</b>&lt;整数1~3&gt;
优化分辨率变化情况下pass2的最优动态向量，<span class="text-blue-emph">1</span>仅搜索动态向量周围的动态，<span class="text-blue-emph">2</span>增加搜索AMVP的顶级候选块，<span class="text-blue-emph">3</span>再搜索更多AMVP候选
<b>--scale-factor</b>&lt;整数1~3&gt;
优化分辨率变化情况下pass2的最优动态向量，<span class="text-blue-emph">1</span>仅搜索动态向量周围的动态，<span class="text-blue-emph">2</span>增加搜索AMVP的顶级候选块，<span class="text-blue-emph">3</span>再搜索更多AMVP候选
<b>--refine-mv-type avc</b>读取API调用的动态信息，目前支持avc大小，使用analyse-reuse模块就用这个参数+avc
<b>--refine-ctu-distortion</b>&lt;整数0~1&gt;
pass 1下用0写，pass 2下用1读取ctu失真信息</code></pre>

            <h4>2pass 转场优化</h4>
            <pre><code><b>--scenecut-aware-qp</b>&lt;整数，默认关，<span class="text-red-emph">仅pass2</span>&gt;
降低转场前/后qp以增加转场画质，类似fades和weightb
    · <span class="text-blue-emph">1</span>仅转前
    · <span class="text-blue-emph">2</span>仅转后
    · <span class="text-blue-emph">3</span>前加后
<b>--analysis-reuse-file</b>&lt;路径，默认x265目录下x265_analysis.dat&gt;
若使用了2pass-ABR调优，则导入multi-pass-opt-analysis/distortion信息的路径，文件名
<b>--masking-strength</b>&lt;逗号分隔整数&gt;
于sct-awr-qp基础上定制qp偏移量。建议根据低~高成本动漫，真人录像三种情况定制参数值。scenecut-aware-qp的三种方向决定了masking-strength的三种方向。所谓的非参考帧就是参考参考帧的帧，包括B，b，P三种帧
    · sct-awr-qp=1时写作<span class="text-blue-emph">&lt;转前毫秒（推500）&gt;,&lt;参考±qp&gt;,&lt;非参±qp&gt;</span>
    · sct-awr-qp=2时写作<span class="text-blue-emph">&lt;转后毫秒（荐500）&gt;,&lt;参考±qp&gt;,&lt;非参±qp&gt;</span>
    · sct-awr-qp=3时写作<span class="text-blue-emph">&lt;转前毫秒&gt;,&lt;参考±qp&gt;,&lt;非参±qp&gt;,&lt;转后毫秒&gt;,&lt;参考±qp&gt;,&lt;非参±qp&gt;</span>
注：x265 v3.5移除了scenecut-window，max-qp-delta，qe-delta-ref，qp-delta-nonref</code></pre>

            <h4>Analysis-Npass 间调优</h4>
            <p>在 Analysis-pass1~2 之间加一步优化计算。实现比普通 2pass 更精细的码率控制，1~N 也行</p>
            <pre><code><b>--multi-pass-opt-analysis</b>&lt;开关，默认生成x265_analysis.dat，<span class="text-red-emph">需关闭pme/pmode/analysis-save|load</span>&gt;
储存/导入每个CTU的参考帧/分块/向量等信息。将信息优化，细化并省去多余计算
<b>--multi-pass-opt-distortion</b>&lt;开关，<span class="text-red-emph">需关闭pme/pmode/analysis-save|load</span>&gt;
根据失真（编码前后画面差）进一步分析qp
<b>--multi-pass-opt-rps</b>&lt;开关，默认关&gt;
将pass1常用的率参数集保存在序列参数集SPS里以加速</code></pre>

            <h4>Analysis-pass2-ABR 天梯模式</h4>
            <pre><code><b>--abr-ladder</b>&lt;文件名.txt，<a href="https://streaminglearningcenter.com/blogs/the-evolving-encoding-ladder-what-you-need-to-know.html">苹果TN2224</a>，<span class="text-red-emph">实验性</span>&gt;
编码器内部实现analysis模式2pass abr多规格压制输出。方便平台布置多分辨率版本用。可以把不变参数写进pass1+2，变化的写进txt。
格式为："[压制名:analysis-load-reuse-level:analysis-load] &lt;参数1+输出文件名1&gt;"
例：
x265.exe --abr-ladder 1440p8000_2160p11000_2160p16000.txt --fps 59.94 --input-dep例th 8 --input-csp i420 --min-keyint 60 --keyint 60 --no-open-gop --cutree
1440p8kb_2160p11kb_2160p16kb.txt {
[1440p:8:Anld存档1] --input 视频.yuv --input-res 2560x1440 --bitrate 8000 --ssim --psnr --csv 9.csv --csv-log-level 2 --output 1.hevc --scale-factor 2
[2160p1:0:nil] --input 视频.yuv --input-res 3840x2160 --bitrate 11000 --ssim --psnr --csv 10.csv --csv-log-level 2 --output 2.hevc --scale-factor 2
[2160p2:10:Anld存档3] --input视频.yuv --input-res 3840x2160 --bitrate 16000 --ssim --psnr --csv 11.csv --csv-log-level 2 --output 3.hevc --scale-factor 0 }</code></pre>

            <h4>近无损与真无损压缩双层模式</h4>
            <pre><code><b>--lossless</b>&lt;开关&gt;
过分块，动/帧/参搜索，量/自适量化等影响画质的步骤，保留率失真优化以增强参考性能。输出体积特大的原画。相比锁定量化方法，这样更能满足影业与科研用，但不适合个人和一般媒体。真无损导出有很小几率因为参考质量提升而会比近无损小
<b>--tskip</b>&lt;开关，默认关，<span class="text-red-emph">需rd大于2</span>&gt;
4x4 tu上跳过DCT变换，可保留深度分块/纹理密集处的放大细节
<b>--cu-lossless</b>&lt;开关，默认关&gt;
将无损量化cu（qp 4）作为率失真优化的结果选项之一，只要码率管够（符合λ=R/D）就不量化。用更多码率换取原画相似度，无损源能提高参考冗余</code></pre>

            <h2>自适应量化</h2>
            <p>CRF/ABR设定每帧量化/qp后，方差自适应量化variance adaptive quantizer 再根据复杂度判断高低频信号，来实现精确到宏块的 qp 分配过程。讨论时注意 aq 与 vaq 的混淆。<a href="https://www.nazorip.site/archives/63">见 x264 教程</a></p>
            
            <pre><code><b>--aq-mode</b>&lt;整数0~3&gt;
据原画和crf/abr设定，以及码率不足时（crf&lt;18/低码abr）如何分配qp
    · <span class="text-blue-emph">1</span>标准自适应量化（急用，简单平面）
    · <span class="text-blue-emph">2</span>加启用aq-variance，自动调整aq-strength强度（录像-电影以及crf&lt;17推荐）
    · <span class="text-blue-emph">3</span>加码率不够用时倾向保暗场（接受更明显的涂抹失真）
    · <span class="text-blue-emph">4</span>加码率不够用时更加倾向保纹理（接受平面上的涂抹失真，<span class="text-red-emph">实验性</span>，很慢）
<b>--aq-strength</b>&lt;浮点&gt;
自适应量化强度。搭配aq-mode，如动漫1:0.8，2:0.9，3:0.7用。录像上可加0.1~0.2，画面混乱/观众难以注意平面时可再增加。注意低成本动漫的平面居多，因此码率不足时反而要妥协纹理
<b>--hevc-aq</b>&lt;开关&gt;
以¼tile而非aq的边缘高频信息实现自适应。据doom9结论<a href="https://forum.doom9.org/showthread.php?p=1925373#post1925373">1</a>，<a href="https://forum.doom9.org/showthread.php?p=1925464">2</a>: hevc-aq比aq 4快且适合动漫，而aq 4更适合录播。目前学术方-官方-第三方间信息较割裂，暂无适解
<b>--aq-motion</b>&lt;开关，<span class="text-red-emph">实验性</span>&gt;
据动态信息微调自适应量化的效果mode和强度strength
<b>--qg-size</b>&lt;64/32/16/8，默认64，<span class="text-red-emph">≥min-cu-size</span>&gt;
偏移蓝，红色色度面相比亮度平面的qp值差异，负值降低量化。如当色度平面的量化太高则可以用这两个参数补偿回来，但x264-5会根据色度平面采样格式（4:2:2，4:4:4）自动设定这些参数。由于编码器一直不擅长深红色，而人眼又对红光敏感，所以可以给红色面设<span class="text-blue-emph">-3</span>左右
<b>--cbqpoffs --crqpoffs</b>&lt;整数偏移值&gt;
据动态信息微调自适应量化的效果mode和强度strength</code></pre>

            <h4>x265 jpsdr-mod 参数</h4>
            <pre class="mb-0"><code><b>--aq-auto</b>&lt;8bit四开关十进制，默认0关&gt;
对应下表：</code></pre>
            <table class="align-items-center table-center">
                <thead>
                    <tr class="border-bottom">
                        <th class="px-1">值</th>
                        <th class="px-1">逐帧 aq</th>
                        <th class="px-1">延迟逐帧 aq</th>
                        <th class="px-1">HDR 兼容</th>
                        <th class="px-1">aq mode 5</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-bottom t-light-gray">
                        <td class="text-blue-emph px-1">1</td>
                        <td class="px-1">√</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-1">2,3</td>
                        <td class="px-1">√</td>
                        <td class="px-1">√</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom t-light-gray">
                        <td class="text-blue-emph px-1">4</td>
                        <td class="px-1">√</td>
                        <td class="px-1"> </td>
                        <td class="px-1">√</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-1">8</td>
                        <td class="px-1">√</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                        <td class="px-1">√</td>
                    </tr>
                    <tr class="border-bottom t-light-gray">
                        <td class="text-blue-emph px-1">6</td>
                        <td class="px-1">√</td>
                        <td class="px-1">√</td>
                        <td class="px-1">√</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-1">10</td>
                        <td class="px-1">√</td>
                        <td class="px-1">√</td>
                        <td class="px-1"> </td>
                        <td class="px-1">√</td>
                    </tr>
                    <tr class="border-bottom t-light-gray">
                        <td class="text-blue-emph px-1">12</td>
                        <td class="px-1">√</td>
                        <td class="px-1"> </td>
                        <td class="px-1">√</td>
                        <td class="px-1">√</td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-1">14</td>
                        <td class="px-1">√</td>
                        <td class="px-1">√</td>
                        <td class="px-1">√</td>
                        <td class="px-1">√</td>
                    </tr>
                </tbody>
            </table>
            <pre><code><b>-aq-fast-edge</b>&lt;开关，<span class="text-red-emph">需aq-mode4,5</span>&gt;
边缘检测跳过高斯模糊过滤，不适合脏片源
<b>--aq-bias-strength</b>&lt;浮点，默认1，<span class="text-red-emph">需aq-mode3,5</span>&gt;
aq-strength偏给暗场的程度
<b>--aq-strength-edge</b>&lt;浮点0~3，默认=aq-strength，<span class="text-red-emph">需aq-mode4,5</span>&gt;
偏给纹理的aq-strength
<b>--aq-bias-strength-edge</b>&lt;浮点，默认=aq-bias-str，<span class="text-red-emph">需aq-mode5</span>&gt;
aq-strength-edge偏给暗场的程度</code></pre>

            <h2>模式决策</h2>
            <p>Mode decision 整合搜来的信息，宏观地定制分块参考量化等细分方案。因为码率最小的压缩方案画质也差。注意片源含明显边缘失真时反而要减少决策优化</p>
            <div class="align-items-center">
                <img src="files/image24.png" alt="Mode Decision General" class="" >
            </div>

            <pre><code><b>--rd</b>&lt;1/2/3/5，默认3，大则慢&gt;
据优化模式决策的程度。 建议快速用<span class="text-blue-emph">1</span>，<span class="text-blue-emph">2</span>；高压用<span class="text-blue-emph">3</span>；片源数据无损(非视觉无损)时用<span class="text-blue-emph">5</span>
    · <span class="text-blue-emph">1</span>优化帧内参考，并块/跳过决策，含明显边缘失真时用
    · <span class="text-blue-emph">2</span>加分块决策，含明显边缘失真时用
    · <span class="text-blue-emph">3</span>加帧间决策，高压高量化时可平衡
    · <span class="text-blue-emph">5==6</span>加向量/帧间方向预测决策，比3慢一倍，片源含边缘失真时会强化失真
<b>--limit-modes</b>&lt;开关&gt;
用附近的4个子CU以判断用merge还是AMVP，会大幅减少rect/amp的效果，提速明显。会增大或减少体积，微降画质但难以察觉
<b>--limit-refs</b>&lt;整数0~3，默认3&gt;
限制分块用信息可参考性。<span class="text-blue-emph">0不限</span>压缩高且慢；<span class="text-blue-emph">1</span>用cu分裂后的信息+差异信息描述自身(推荐)；<span class="text-blue-emph">2</span>据单个cb的差异信息建立pu；<span class="text-blue-emph">3=1+2</span>
<b>--rskip</b>&lt;整数0~2&gt;
前cu分块被跳过时，判断后cu接着搜索分块还是提前退出的参数。画面越接近录屏/低成本动漫就用得越多
    · <span class="text-blue-emph">0</span>继续分析。适合信噪比差/高噪源。原画很干净则不如<span class="text-blue-emph">1</span>
    · <span class="text-blue-emph">1</span>rd 0~4下据临cu是否细分而定；rd5~6下看附近2Nx2N cu分块难度而定，高压和一般情况推荐
    · <span class="text-blue-emph">2</span>直接对比cu纹理密度Edge Density，快且不比前者差，但存在对源的画质要求及客观判断“画质”的能力
<b>--tskip-fast</b>&lt;开关，默认关&gt;
跳过4x4 tu的变换，忽略部分DCT系子coefficients来加速，CbCr-tu也取决于Y块是否被跳过。在全屏小细节的视频中有显著加速效果。建议除高压以外的情况使用
<b>--rskip-edge-threshold</b>&lt;0~100，默认5: 趋向于分块，<span class="text-red-emph">需rskip大于1</span>&gt;用Sobel算法获取cu纹理密度再除以块所占面积的百分比。纹理密度&gt;阈值=分块，量化强度越高越关键。8×8或16×16块下默认5%（即含3或12个系子）就分
注：类似x264 deadzone参数
    · 像素风：<span class="text-blue-emph">据像素变大的程度决定</span>。如分辨率宽÷2，分辨率高÷2会回到1x1像素大小，则使默认值乘以2以提速
    · 抗涂抹：<span class="text-blue-emph">rskip 2 rskip-edge-threshold 3</span>。即“有一点不平就应分块”。比rskip 0快，用于已知要保留雪景等全屏大量动态信息的源的情况下，节省传统分块计算时间。可=在不添噪点的情况下达成抗涂抹的目的</code></pre>
            <div class="align-items-center">
                <img src="files/image25.png" alt="rSkip Edge Threshold" class="img-small" >
                <p class="text-gray-side">图：影响 DCT 系子分布的块中像素，而 DCT 系子的密度影响 rskip-edge-threshold 的设置</p>
            </div>

            <h2>率失真优化控制</h2>
            <h4>率失真优化 Rate distortion optimization</h4>
            <p>简单地说，将失真；码率分别看做两种越大越差的程度；将其中一个程度乘以一个缩放值以对齐另一个（否则两值权重不一样），然后在各种模式决策，量化方案下找出最小的和，就有了最优方案。由代价函数「开销=失真+λ⋅码率」（越小越好）实现模式决策：
            </p>
            <span class="text-blue-math">\[J = D + \lambda \cdot R\]</span>
            <p>由于这个式子是一元一次函数（ <span class="text-blue-math">\(y = mx + b\)</span> ），所以可画图表示为每个方案 J 作为位于 D，R 坐标系，斜度 λ 线上的点；其中失真 D 用平方差 SSE 或总差异 SAD 判断（SSE 多取一步平方，使较大的差异呈指数增长）进而分到更多补偿的码率。拉格朗日值 λ 源于 qp，即 crf，abr 指定的率失真斜度区间。qp 越大斜度越小：</p>
            <ul>
                <li><span class="text-blue-math">\(\lambda=0\)</span>则无斜度，则代价等于失真——码率变而画质不变，宜压缩。</li>
                <li><span class="text-blue-math">\(\lambda \rightarrow 0\)</span>（趋 0）则开销趋失真——适当压缩就不会影响画质</li>
                <li><span class="text-blue-math">\(\lambda &gt; 0\)</span>则开销大于失真——保画质收益大于压缩收益，应该保画质</li>
            </ul>
            <div class="align-items-center">
                <img src="files/image26.png" alt="x264 JM RDO Lambda" class="img-medium" >
                <img src="files/image27.png" alt="RDO Lambda Slopes" class="img-medium" >
                <p class="text-gray-side">图：率失真优化中λ的斜度变化与效果</p>
                <img src="files/image28.png" alt="RDO qStep Chart" class="img-medium" >
                <p class="text-gray-side">图：率 - 失真表格中不断调整并得到“×”的实际效果</p>
            </div>

            <p>x265 的失真（块间差异）用均方差 Mean Squared Error（MSE）判断：</p>
            <span class="text-blue-math">$$\frac{1}{n^2}\sum_{x=0}^{n-1}{\sum_{y=0}^{n-1}{\ |f(x,y) - f\prime(x,y)|^2}}$$</span>
            <p>x264 中默认用更快的平方差 Sum of Squared Error（SSE），或 Sum of Squared Difference（SSD）:</p>
            <span class="text-blue-math">$$\sum_{x=0}^{n-1}{\sum_{y=0}^{n-1}{\ |f(x,y) - f\prime(x,y)|^2}}$$</span>
            <p>x264 中还可选用画质优先的高频加权平方差 Noise SSE（见 <a href="https://web.archive.org/web/20090916181521/http://x264dev.blogspot.com/2008/05/film-grain-optimization.html">Dark Shikari 帖子</a>和<a href="https://forum.doom9.org/showthread.php?p=1127999">doom9 论坛</a>）：</p>
            <span class="text-blue-math text-smaller">$$\sum_{x=0}^{n-1}{\sum_{y=0}^{n-1}{\ \left| \left\lbrack N(x,y) - \ N\prime(x,y) \right\rbrack \cdot fgo \right| + |f(x,y) - f\prime(x,y)|^2}}$$</span>
            <p>其中 N/Noise 代表块的噪点强度，在一个 2x2 的区间下为四个像素两两加减得到，因为噪点和其它高频信号一样都是突兀的像素值（所以速度很慢）：</p>
            <span class="text-blue-math">$$N(0,0)=|f(0,0)-f(0,1)+f(1,1)-f(0,1)|$$</span>
            <ul class="text-gray-side">
                <li>
                    <span class="text-blue-math">\(n\)</span>为块的大小边界，当然此处未考虑 x265 rect 和 asm CU 的长方形
                </li>
                <li>
                    <span class="text-blue-math">\(\sum_{x=0}^{n-1}{\sum_{y=0}^{n-1}}\)</span>分别指块宽，块高的求和范围
                </li>

                <li>
                    <span class="text-blue-math">\(x,y\)</span>代表块中各个像素值的坐标
                </li>
                <li><span class="text-blue-math">| |</span> 求绝对值以正常求和</li>
            </ul>

            <h4>优化策略 - 随量化强度增加而增加</h4>
            <div class="align-items-center">
                <img src="files/image29.jpg" alt="RDO Settings 1" class="" >
                <p class="text-gray-side">图：左 1 源有微量边缘失真以及颗粒。2~4=高量化导致块失真，worm，蚊噪等。5 对应失真用 psy-rd(oq)，(limit)sao，deblock，aq，降 crf 抑制</p>
                <img src="files/image30.png" alt="RDO Settings 2" class="img-medium" >
            </div>

            <h4>优化模式决策</h4>
            <pre><code><b>--dynamic-rd</b>&lt;整数0~4，<span class="text-red-emph">需rd小于5</span>&gt;
给VBR限码画面调高rd止损。1~4为rd搜索面积倍数，大则慢
<b>--splitrd-skip</b>&lt;开关，默认关&gt;
在“所有当前CU分割致失真程度之总和”大于“同帧CU分割致失真程度之总和”时，不独立计算rd值以加速
<b>--qp-adaptation-range</b>&lt;浮点1~6，默认1&gt;
psy参数改动qp的最大范围，宏观影响大，片源含明显边缘失真时会强化失真
<b>--psy-rd</b>&lt;浮点偏移值0~50，，默认2.0，<span class="text-red-emph">需rd 3，加psy-rdoq后构成x264 psy-rd参数</span>&gt;
心理视觉优化往高影响量化块的能量J，使md偏好保留细节的程度，值随分辨率增加而增加，随片源边缘失真增加而降低，并随量化强度增加而增加
    · <span class="text-blue-emph">0~0.1</span>片源有明显边缘失真（和细节同是高频信号），优化则降低画质
    · <span class="text-blue-emph">0.2</span>高压或片源暗场有一点点边缘失真
    · <span class="text-blue-emph">0.5~2</span>根据要保留的边缘峭度以及文件大小，VBR模式的峰值码率决定
    · <span class="text-blue-emph">1.5~2.5</span>至少2k的录像片源，根据分辨率和边缘失真程度决定
<b>--rd-refine</b>&lt;开关，<span class="text-red-emph">需rd 5，见下图斜面上出现的随机块失真</span>&gt;
率失真优化分析完成帧内搜索cu的最佳量化和分块结果，耗时换压缩率和画质。x264中直接嵌入subme 8中，还多一个最优动态向量分析</code></pre>
            <div class="align-items-center">
                <img src="files/image31.jpg" alt="RD Refine Random Distortion" class="img-medium" >
            </div>

            <h4>优化量化</h4>
            <pre><code><b>--rdoq-level</b>&lt;整数，0~2&gt;
abr/crf分配量化值的宏观调控强度，大则慢，0则关
    · <span class="text-blue-emph">1</span>逐分块进行率失真优化量化，psy-rdoq开启则倾向低量化
    · <span class="text-blue-emph">2</span>对比4x4块高频信息/残差是否有利于整个编码组(CTU内分块)画质，同时对所有系子进行同类分析，大量减少4×4块，降低psy-rdoq效果，适合一般及高压缩用途
<b>--psy-rdoq</b>&lt;浮点0~50，默认0关&gt;
心理视觉往高影响量化块的能量J，改量化偏好为保留细节。值随分辨率增加而增加，随片源边缘失真增加而降低，并随量化强度增加而增加
    · <span class="text-blue-emph">0~0.1</span>片源有明显边缘失真（和细节同是高频信号），优化则降低画质
    · <span class="text-blue-emph">2.3~2.8</span>电脑录屏，中低成本动漫等几乎没有动态背景变化的情况
    · <span class="text-blue-emph">3~4.8</span>分辨率从1280x720到3840x2160的高成本电影动漫，要求片源无明显边缘失真
    · <span class="text-blue-emph">7~12+psy-rd 3，tskip，tskip-fast，ipratio 1.2，no-sao</span>留噪。保的细节面积越小越高
<b>--nr-intra --nr-inter</b>&lt;整数0关~2000，默认0，<a href="http://forum.doom9.net/showthread.php?s=81cd7c04a679401fe7c4e689e67eaeb8&p=1947571#post1947571">1920x1080不建议超250</a>&gt;
基于MC结果给量化前变换完的i帧降噪。nr-intra不如第三方降噪滤镜。但帧间/时域上降噪的nr-inter可以拉近参考源和参考帧的差距/残差，实现在rc-grain上进一步稳定qp值波动，且在噪点源中相比模糊掉纹理更容易破坏噪点,结果类似低配双阈滤镜</code></pre>

            <h4>峰值信噪比 Peak signal-noise ratio PSNR</h4>
            <p>不只是人眼对光压的感知，包括痛觉冷热音量等强度的感知皆呈对数㏒状，因此对数被用于统计信号强度，如突出重点范围变化的分贝 dB 表示。信噪比 SNR 即「信号÷噪声」，用于测量处理传输变换信号的有效信息所剩。使用㏒统计还有在坐标系中撇开信噪比太好太差数据（指数增长缩放成线性增长）的效果。</p>
            <p class="text-blue-math">$$PSNR_{8bit} = 10 \log_{10} \left( \frac{2^{8bit}-1}{MSE} \right) \,\text{(dB)}$$</p>

            <ul class="text-gray-side">
                <li>PSNR 用来判断编码前后的画面差距，此处画面差异记为均方差 MSE</li>
                <li>右侧减 1 代表从 0 开始数，㏒<sub>10</sub>对齐十进制</li>
            </ul>

            <h2>环路滤波</h2>
            <h4>去块滤镜</h4>
            <p>修复高量化时宏块间出现明显横纵割痕瑕疵的平滑滤镜。编码器内去块利用了之前搜索到的信息而相比外部滤镜误判更少，但大体上就是检查 1 像素宽，且周围没有较大高度/像素值变化的横纵边缘，所以误判也不可避免。</p>
            <p>块失真源自块间不统一的量化程度。而去块手段是平滑滤镜，因此要降低强度才适用于高码视频，动漫，素材录屏等锐利画面。边界强度 Boundary strength（去块力度判断）</p>
            <div class="align-items-center">
                <img src="files/image32.png" alt="Deblock detection visualization" class="img-medium" >
                <img src="files/image33.png" alt="Deblock edge visualization" class="img-medium" >
                <p class="text-gray-side">图：取最小 8x8 范围（两个 4x4 CU）间的界线举例。</p>
            </div>

            <ul class="text-smaller">
                <li>平滑 4：a 与 1 皆为帧内块，且边界位于 CTU/宏块间，最强滤镜值</li>
                <li>平滑 3：a 或 1 皆为帧内块，但边界不在 CTU/宏块间</li>
                <li>平滑 2：a 与 1 皆非帧内块，含一参考源/已编码系子</li>
                <li>平滑 1：a 与 1 皆非帧内块，皆无参考源/已编码系子，溯异帧或动态向量相异</li>
                <li>平滑 0：a 与 1 皆非帧内块，皆无参考源/已编码系子，溯同帧或动态向量相同，滤镜关</li>
            </ul>
            <pre><code><b>--deblock</b>&lt;浮点偏移值，平滑强度:搜索精度，默认1:0，推荐0:0，-1:-1，-2:-1&gt;
两值于原有强度上增减
    · 平滑<span class="text-blue-emph">≥1</span>时用以压缩
    · 平滑<span class="text-blue-emph">-2~-1</span>时略降锐度，适合串流
    · 平滑<span class="text-blue-emph">2</span>适合锐利视频源，4k电影，游戏录屏。提高码率且会出现块失真
    · 平滑<span class="text-blue-emph">-3~-2</span>适合高码动画源/桌面录屏。增块失真，但观感还是比1好
    · 搜索<span class="text-blue-emph">大于2</span>易误判；<span class="text-blue-emph">小于1</span>会遗漏。建议保持<span class="text-blue-emph">0~-1</span>，除非qp大于26时设<span class="text-blue-emph">1</span></code></pre>

            <h4>取样迁就偏移滤镜 Sample adaptive offset</h4>
            <div class="row">
                <p id="LR-UD-025" class="col-10">逐 CTB 划分。界偏移 EO 缓解纹理边缘因「高频波形的遮盖因强量化或去块丢失」的问题。可能分以下几步。算法略像帧内搜索的趋平滤镜。适合修复纹理量化出振铃的损失。关闭则遮不住平面的蠕虫失真</p>
                <img src="files/image34.jpg" alt="Sample Adaptive Offset Case" id="LR-UD-026" class="img-small img-right col-2 mb-auto" >
            </div>

            <ul class="text-gray-side">
                <li>CTB 内据分块结果建立一批 3x3 像素的采样域</li>
                <li>由 3x3 排列规律找出三个像素排成一排的横 0，纵 1，左倾 2 和右倾 3 四种可能</li>
                <li>中心像素值要符合小于/大于旁像素且等于任意一边像素的条件，否则不是边界</li>
                <li>确保 3x3 间的边界连续性，实现边界验证和性能优化</li>
            </ul>
            <p>带偏移 BO 滤镜对比源 + 补偿编码差异的平面 CTB，适合补偿平面，斜面和曲面渐变 CU，以及修复平面量化的损失。方法是：</p>
            <ol>
                <li>划分 32 条色深带来均分当前色深下的像素值</li>
                <li>分为 24~31，0~7 的明带，暗带；以及 8~23 的中间带</li>
                <li>限制最大只能补偿 4 条相连的色深带，以确保 CTB 中色深差异不会大到触发 EO 同时涵盖足够大的斜面渐变</li>
                <li>率失真优化找出所谓的补偿值：每条色深带的偏移值</li>
            </ol>
            <ul class="text-gray-side">
                <li>共有 0=无，1=横 E0，2=纵 EO，3=左倾 EO，4=右倾 EO，5=中间带，6=明暗带，共 7 种补偿方案</li>
                <li>共有 0=无，1=Y，2=Y+Cr，3=Y+Cb，4=YCbCr，5=Cr，6=Cb，7=CbCr 种平面补偿开关</li>
            </ul>
            <p>融合 Merge 滤镜将相邻两个 CTB 的 SAO 信息（补偿方案，平面补偿开关等）根据参数决定直接用上/左块，还是对比像素趋势更接近哪个。和选择 BO，EO 具体的偏移值一样由率失真优化决定</p>
            
            <pre><code><b>--no-sao</b>&lt;关闭sao，默认开--sao&gt;
由于针对的是强量化环境，所以高画质源+crf小于17的情况下可以关
<b>--sao-non-deblock</b>&lt;开关&gt;
启用后，未经由deblock分析的内容会被sao分析
<b>--no-sao-non-deblock</b>&lt;默认&gt;
sao分析跳过视频右边和下边边界
<b>--limit-sao</b>&lt;开关，默认关&gt;
对一些计算采用提前退出策略，不是改善画质的，但crf≈18，cutree和bframes 16下可以开，以保留一定影响
<b>--selective-sao</b>&lt;0~4，默认0&gt;
从条带（横向的一组CTU）角度调整sao参数，1启用I条带sao，2增加P条带，3增加B条带，4所有条带。可直接控制sao，或搭配limit-sao的新方法</code></pre>

            <h2>熵编码/文本压缩</h2>
            <div class="align-items-center">
                <img src="files/image35.png" alt="CABAC Flow Chart" class="" >
                <p class="text-gray-side">图：简化的上下文自适应二进制算数编码<a href="https://iphome.hhi.de/marpe/cabac.html">CABAC 流程</a>，分转二进制，出字概率统计和算数编码三步</p>
            </div>

            <h4>算数编码</h4>
            <p>CABAC 的核心结构。将输入文本按字数多少分割 0~1 间的出字概率。优化是尽可能控制概率分布条上落点（得尽可能短的结果小数），以及通过降噪变换量化和游程编码以简化输入信号，实现尽可能高的无损压缩</p>
            <div class="align-items-center">
                <img src="files/image36.png" alt="Arithmetic Coding Demonstration" class="" >
                <p class="text-gray-side">图：编码即逐字按出字概率缩窄概率条到最后一个字的出字概率，取上/下区间为编码结果，解码照概率位置（蓝线）的落点反推实现。</p>
            </div>

            <h4>自适应 Adaptive 与对等 Uniform 概率</h4>
            <p>预先统计出字概率（要读取全文）的特性限制了算数编码的用途，而解决方法是利用文本编码一次编一字的特性——以「编一字，一改出字概率」的推演，逐字地适配成合理的概率。添切换符 ⊗ 代表自适概率 0 的生字，以临时用对等概率编码（仅推演概率，编码部分以及 0~1 区间的概率分布变化结合上图）：</p>
            <table class="text-gray-side table-fit-container align-items-center">
                <thead>
                    <tr>
                        <th>1</th>
                        <th class="text-green-dyna">造词典</th>
                        <th> </th>
                        <th> </th>
                        <th> </th>
                        <th> </th>
                        <th> </th>
                        <th> </th>
                        <th> </th>
                        <th>切换符</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>出字词典</td>
                        <td>h</td>
                        <td>e</td>
                        <td>l</td>
                        <td>o</td>
                        <td> </td>
                        <td>w</td>
                        <td>r</td>
                        <td>d</td>
                        <td>⊗</td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>对等概率</td>
                        <td>1/8</td>
                        <td>1/8</td>
                        <td>1/8</td>
                        <td>1/8</td>
                        <td>1/8</td>
                        <td>1/8</td>
                        <td>1/8</td>
                        <td>1/8</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <th>2</th>
                        <th class="text-green-dyna">编码 h</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td class="text-pink-cnsq">1/2</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1/2</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td class="text-blue-cnsq">⊗h</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>3</th>
                        <th class="text-green-dyna">编码 e</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/3</td>
                        <td class="text-pink-cnsq">1/3</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1/3</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td class="text-blue-cnsq">⊗e</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>4</th>
                        <th class="text-green-dyna">编码 l</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/4</td>
                        <td>1/4</td>
                        <td class="text-pink-cnsq">1/4</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1/4</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td>⊗e</td>
                        <td class="text-blue-cnsq">⊗l</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>5</th>
                        <th class="text-green-dyna">编码 l</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/5</td>
                        <td>1/5</td>
                        <td class="text-pink-cnsq">2/5</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1/5</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td>⊗e</td>
                        <td class="text-blue-cnsq">⊗ll</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>6</th>
                        <th class="text-green-dyna">编码 o</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/6</td>
                        <td>1/6</td>
                        <td>2/6</td>
                        <td class="text-pink-cnsq">1/6</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1/6</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td>⊗e</td>
                        <td>⊗ll</td>
                        <td class="text-blue-cnsq">⊗o</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>7</th>
                        <th class="text-green-dyna">编码空格</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/7</td>
                        <td>1/7</td>
                        <td>2/7</td>
                        <td>1/7</td>
                        <td class="text-pink-cnsq">1/7</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1/7</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td>⊗e</td>
                        <td>⊗ll</td>
                        <td>⊗o</td>
                        <td class="text-blue-cnsq">⊗</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>8</th>
                        <th class="text-green-dyna">编码 w</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/8</td>
                        <td>1/8</td>
                        <td>2/8</td>
                        <td>1/8</td>
                        <td>1/8</td>
                        <td class="text-pink-cnsq">1/8</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1/8</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td>⊗e</td>
                        <td>⊗ll</td>
                        <td>⊗o</td>
                        <td>⊗</td>
                        <td class="text-blue-cnsq">⊗w</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>9</th>
                        <th class="text-green-dyna">编码 o</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/9</td>
                        <td>1/9</td>
                        <td>2/9</td>
                        <td>2/9</td>
                        <td>1/9</td>
                        <td class="text-pink-cnsq">1/9</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1/9</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td>⊗e</td>
                        <td>⊗ll</td>
                        <td>⊗o</td>
                        <td>⊗</td>
                        <td class="text-blue-cnsq">⊗wo</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>10</th>
                        <th class="text-green-dyna">编码 r</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/10</td>
                        <td>1/10</td>
                        <td>2/10</td>
                        <td>2/10</td>
                        <td>1/10</td>
                        <td>1/10</td>
                        <td class="text-pink-cnsq">1/10</td>
                        <td>0</td>
                        <td>1/10</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td>⊗e</td>
                        <td>⊗ll</td>
                        <td>⊗o</td>
                        <td>⊗</td>
                        <td>⊗wo</td>
                        <td class="text-blue-cnsq">⊗r</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>11</th>
                        <th class="text-green-dyna">编码 l</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/11</td>
                        <td>1/11</td>
                        <td>3/11</td>
                        <td>2/11</td>
                        <td>1/11</td>
                        <td>1/11</td>
                        <td class="text-pink-cnsq">1/11</td>
                        <td>0</td>
                        <td>1/11</td>
                    </tr>
                    <tr class="border-bottom">
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td>⊗e</td>
                        <td>⊗ll</td>
                        <td>⊗o</td>
                        <td>⊗</td>
                        <td>⊗wo</td>
                        <td class="text-blue-cnsq">⊗rl</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <th>12</th>
                        <th class="text-green-dyna">编码 d</th>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>自适概率</td>
                        <td>1/12</td>
                        <td>1/12</td>
                        <td>3/12</td>
                        <td>2/12</td>
                        <td>1/12</td>
                        <td>1/12</td>
                        <td>1/12</td>
                        <td class="text-pink-cnsq">1/12</td>
                        <td>1/12</td>
                    </tr>
                    <tr>
                        <td>生成字符</td>
                        <td>⊗h</td>
                        <td>⊗e</td>
                        <td>⊗ll</td>
                        <td>⊗o</td>
                        <td>⊗</td>
                        <td>⊗wo</td>
                        <td>⊗rl</td>
                        <td class="text-blue-cnsq">⊗d</td>
                        <td>EOF</td>
                    </tr>
                </tbody>
            </table>

            <h4>上下文自适应 - 类 LZ 的 PPM 推演法简化版</h4>
            <p>拓展上例思路作上下文长 0——CTX0 时的推演，添加 CTX1 或更高的范围。每进一位字就「先查长，后查短，生字用对等；匹长概大，配短概小」的上下文自适应出字概率推演。其中部分匹配预测法 Prediction by Partial Matching 设最长 3 字编码 DNA 链单侧的 CTAGGCAATCTAGGTA 时，推演过程如下：</p>
            <ul class="text-gray-side text-smaller">
                <li>CTX<sub>-1</sub>-—无上下文 (null) 的 <sub>-1</sub>初始态，储存对等概率，编码生字</li>
                <li>CTX<sub>0</sub>——输入=字符 1 时，上下文为“”的状态，一次输一字，相当于自适应概率本身</li>
                <li>CTX<sub>1</sub>——输入=字符 2 时，上下文为“&lt;字符 1&gt;”的状态</li>
                <li>CTX<sub>2</sub>——输入≥字符 n 时，上下文为“&lt;…&gt;&lt;字符 n-2&gt;&lt;字符 n-1&gt;”的状态</li>
                <li>⊗———切换符，叠加以显示临时倒退了多少个 CTX 表，各个 CTX 表也因此有 ⊗ 的概率</li>
                <li>「匹长概大，配短概小」: 先用最长且小于等于已知上下文长度的 CTXn 编码输入符号，该情况下出字概率最大</li>
            </ul>
            <ol class="text-smaller">
                <li>
                    据已知上下文内容找到各个长度上下文中的概率分组（此处用分色表示）
                    <ol>
                        <li>新组 ⊗ 的概率记为 1 倍，匹配到同组则用最新的概率倍数</li>
                        <li>旧组 ⊗ 的概率为最新的概率倍，如已存在一项则 ⊗ 的概率为 1/2</li>
                    </ol>
                </li>
                <li><b>小计</b>：统计 2，2A，2B 的编码文本与概率结果</li>
                <li>
                    <b>CTX 更新</b>：统计 2，2A，2B 的编码文本与概率结果
                    <ol>
                        <li>新组建立新的½概率，添加对应的 ⊗ 概率</li>
                        <li>旧组更新概率，如 1/2 到 2/3，1/3 到 2/4，以及更新 ⊗ 概率</li>
                    </ol>
                </li>
            </ol>

            <table class="table-fit-container align-items-center text-xs">
                <thead class="thead-no-border">
                    <tr class="t-invert-dark">
                        <th>出字词典</th>
                        <th>C</th>
                        <th>T</th>
                        <th>A</th>
                        <th>G</th>
                        <th>⊗</th>
                        <th> </th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="t-invert-dark">
                        <td>等概 CTX<sub>-1</sub></td>
                        <td>1/5</td>
                        <td>1/5</td>
                        <td>1/5</td>
                        <td>1/5</td>
                        <td>1/5</td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light"><!--1-->
                        <th>1:</th>
                        <td>输入 C</td>
                        <td>已知 null</td>
                        <td>null 长 0</td>
                        <td class="t-align-right"><span class="text-red-emph">C</span>TAGGCAATC</td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--1-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 匹配⊗</td>
                        <td>CTX<sub>-1</sub>配 C</td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--1-->
                        <td>已知长 0 跳过 </td>
                        <td>已知长 0 跳过</td>
                        <td>已知长 0 跳过</td>
                        <td>⊗</td>
                        <td>C</td>
                        <td>"⊗C"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--1-->
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>P⊗ = 1</td>
                        <td>P(C)=1/5</td>
                        <td>1×1/5</td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--1-->
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>P(""C)=1/2</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr"><!--1-->
                        <td>⊗ 概率</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>P⊗=1/2</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light"><!--2-->
                        <th>2：</th>
                        <td>输入 T</td>
                        <td>已知"C"</td>
                        <td>已知长 1</td>
                        <td class="t-align-right"><span class="text-blue-emph">C</span><span class="text-red-emph">T</span>AGGCAATC</td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--2-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 匹配⊗</td>
                        <td>CTX<sub>-1</sub>配 T</td>
                        <td>小计</td>
                    </tr>
                     <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--2-->
                        <td>已知长 1 跳过 </td>
                        <td>已知长 1 跳过</td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>T</td>
                        <td>"⊗⊗T"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--2-->
                        <td> </td>
                        <td> </td>
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1/2</td>
                        <td>P(T)=1/5</td>
                        <td>1×1/2×<br>1/5</td>
                    </tr>
                     <tr class="border-lr">
                        <td>CTX 更新</td><!--2-->
                        <td> </td>
                        <td> </td>
                        <td>P("C"T)=1/2</td>
                        <td>P(""C)=1/3</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                     <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--2-->
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>P(""T)=1/3</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr"><!--2-->
                        <td>⊗ 概率</td>
                        <td> </td>
                        <td> </td>
                        <td>P⊗=1/2</td>
                        <td>P⊗=1/3</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light"><!--3-->
                        <th>3：</th>
                        <td>输入 A</td>
                        <td>已知"CT"</td>
                        <td>已知长 2</td>
                        <td class="t-align-right"><span class="text-blue-emph">CT</span><span class="text-red-emph">A</span>GGCAATC</td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--3-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 匹配⊗</td>
                        <td>CTX<sub>-1</sub>配 A</td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--3-->
                        <td>已知长 2 跳过 </td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>A</td>
                        <td>"⊗⊗⊗A"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--3-->
                        <td> </td>
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1/3</td>
                        <td>P(A)=1/5</td>
                        <td>1×1×<br>1/3×1/5</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--3-->
                        <td> </td>
                        <td>P("CT"A)=1/2</td>
                        <td>P("C"T)=1/2</td>
                        <td>P(""C)=1/4</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--3-->
                        <td> </td>
                        <td> </td>
                        <td>P("T"A)=1/2</td>
                        <td>P(""T)=1/4</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--3-->
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>P(""A)=1/4</td>
                        <td> </td>
                        <td> </td><!--3-->
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td>
                        <td> </td>
                        <td>P⊗=1/2</td>
                        <td>P⊗=1/2,1/2</td>
                        <td>P⊗=1/4</td>
                        <td> </td>
                        <td> </td><!--3-->
                    </tr>
                    <tr class="t-invert-light"><!--4-->
                        <th>4：</th>
                        <td>输入 G</td>
                        <td>已知"CTA"</td>
                        <td>已知长 3</td>
                        <td class="t-align-right"><span class="text-blue-emph">CTA</span><span class="text-red-emph">G</span>GCAATC</td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--4-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 匹配⊗</td>
                        <td>CTX<sub>-1</sub>配 G</td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--4-->
                        <td>⊗ </td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>G</td>
                        <td>"⊗⊗⊗⊗G"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--4-->
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1/4</td>
                        <td>P(G)=1/5</td>
                        <td>1×1×<br>1×1/5×<br>1/4×1/5</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--4-->
                        <td>P("CTA"G)=1/2</td>
                        <td>P("CT"A)=1/2</td>
                        <td>P("C"T)=1/2</td>
                        <td>P(""C)=1/5</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--4-->
                        <td> </td>
                        <td>P("TA"G)=1/2</td>
                        <td>P("T"A)=1/2</td>
                        <td>P(""T)=1/5</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--4-->
                        <td> </td>
                        <td> </td>
                        <td>P("A"G)=1/2</td>
                        <td>P(""A)=1/5</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--4-->
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>P(""G)=1/5</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr"><!--5-->
                        <td>⊗ 概率</td>
                        <td>P⊗=1/2</td>
                        <td>P⊗=1/2,1/2</td>
                        <td>P⊗=1/2,1/2,<br>1/2</td>
                        <td>P⊗=1/5</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light"><!--5-->
                        <th>5：</th>
                        <td>输入 G</td>
                        <td>已知"TAG"</td>
                        <td> </td>
                        <td class="t-align-right"><span class="text-blue-emph">CTAG</span><span class=text-red-emph>G</span>CAATC</td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--5-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 配 G</td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--5-->
                        <td>⊗ </td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>G</td>
                        <td> </td>
                        <td>"⊗⊗⊗G"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--5-->
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P(""G)=1/5</td>
                        <td> </td>
                        <td>1×1×1</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--5-->
                        <td>P("CTA"G)=1/2</td>
                        <td>P("CT"A)=1/2</td>
                        <td>P("C"T)=1/2</td>
                        <td>P(""C)=1/6</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--5-->
                        <td>P("TAG"G)=1/2</td>
                        <td>P("TA"A)=1/2</td>
                        <td>P("T"A)=1/2</td>
                        <td>P(""T)=1/6</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--5-->
                        <td>P("AG"G)=1/2</td>
                        <td>P("A"G)=1/2</td>
                        <td>P(""A)=1/6</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--5-->
                        <td> </td>
                        <td>P("G"G)=1/2</td>
                        <td>P(""G)=2/6</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr"><!--5-->
                        <td>⊗ 概率</td>
                        <td>P⊗=1/2,1/2</td>
                        <td>P⊗=1/2,1/2,<br>1/2</td>
                        <td>P⊗=1/2,1/2,<br>1/2,1/2</td>
                        <td>P⊗=1/6</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light"><!--6-->
                        <th>6：</th>
                        <td>输入 C</td>
                        <td>已知"AGG"</td>
                        <td> </td>
                        <td class="t-align-right"><span class="text-blue-emph">CTAGG</span><span class="text-red-emph">C</span>AATC</td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--6-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 配 C</td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--6-->
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>C</td>
                        <td> </td>
                        <td>"⊗⊗⊗C"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--6-->
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P"G"⊗ = 1/2</td>
                        <td>P(""C)=1/6</td>
                        <td> </td>
                        <td>1×1×<br>1/2×1/6</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--6-->
                        <td>P("CTA"G)=1/2</td>
                        <td>P("CT"A)=1/2</td>
                        <td>P("C"T)=1/2</td>
                        <td>P(""C)=2/7</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--6-->
                        <td>P("TAG"G)=1/2</td>
                        <td>P("TA"G)=1/2</td>
                        <td>P("T"A)=1/2</td>
                        <td>P(""T)=1/7</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--6-->
                        <td>P("AGG"C)=1/2</td>
                        <td>P("AG"G)=1/2</td>
                        <td>P("A"G)=1/2</td>
                        <td>P(""A)=1/7</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--6-->
                        <td> </td>
                        <td>P("GG"C)=1/2</td>
                        <td>P("G"G)=1/3</td>
                        <td>P(""G)=2/7</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--6-->
                        <td> </td>
                        <td> </td>
                        <td>P("G"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr"><!--6-->
                        <td>⊗ 概率</td>
                        <td>P⊗=1/2,1/2,<br>1/2</td>
                        <td>P⊗=1/2,1/2,<br>1/2,1/2</td>
                        <td>P⊗=1/2,1/2,<br>1/2,1/3</td>
                        <td>P⊗=1/7</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light">
                        <th>7：</th><!--7-->
                        <td>输入 A</td>
                        <td>已知"GGC"</td>
                        <td> </td>
                        <td class="t-align-right"><span class="text-blue-emph">CTAGGC</span><span class="text-red-emph">A</span>ATC</td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--7-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 配 A</td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--7-->
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>A</td>
                        <td> </td>
                        <td>"⊗⊗⊗A"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--7-->
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1/2</td>
                        <td>P(""A)=1/7</td>
                        <td> </td>
                        <td>1/2×1/7</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--7-->
                        <td>P("CTA"G)=1/2</td>
                        <td>P("CT"A)=1/2</td>
                        <td>P("C"T)=1/3</td>
                        <td>P(""C)=2/8</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--7-->
                        <td>P("TAG"G)=1/2</td>
                        <td>P("TA"G)=1/2</td>
                        <td>P("T"A)=1/2</td>
                        <td>P(""T)=1/8</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--7-->
                        <td>P("AGG"C)=1/2</td>
                        <td>P("AG"G)=1/2</td>
                        <td>P("A"G)=1/2</td>
                        <td>P(""A)=2/8</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--7-->
                        <td>P("GGC"A)=1/2</td>
                        <td>P("GG"C)=1/2</td>
                        <td>P("G"G)=1/3</td>
                        <td>P(""G)=2/8</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--7-->
                        <td> </td>
                        <td>P("GC"A)=1/2</td>
                        <td>P("G"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--7-->
                        <td> </td>
                        <td> </td>
                        <td>P("C"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td><!--7-->
                        <td>1/2,1/2,1/2,<br>1/2</td>
                        <td>1/2,1/2,1/2,<br>1/2,1/2</td>
                        <td>1/3,1/2,1/2,<br>1/3</td>
                        <td>P⊗=1/8</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light">
                        <th>8：</th><!--8-->
                        <td>输入 A</td>
                        <td>已知"GCA"</td>
                        <td> </td>
                        <td class="t-align-right"><span class="text-blue-emph">CTAGGCA</span><span class="text-red-emph">A</span>TC</td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--8-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 配 A</td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--8-->
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>A</td>
                        <td> </td>
                        <td>"⊗⊗⊗A"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--8-->
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P"A"⊗ = 1/2</td>
                        <td>P(""A)=1/8</td>
                        <td> </td>
                        <td>1/2×2/8</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--8-->
                        <td>P("CTA"G)=1/2</td>
                        <td>P("CT"A)=1/2</td>
                        <td>P("C"T)=1/3</td>
                        <td>P(""C)=2/9</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--8-->
                        <td>P("TAG"G)=1/2</td>
                        <td>P("TA"G)=1/2</td>
                        <td>P("T"A)=1/2</td>
                        <td>P(""T)=1/9</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--8-->
                        <td>P("AGG"C)=1/2</td>
                        <td>P("AG"G)=1/2</td>
                        <td>P("A"G)=1/3</td>
                        <td>P(""A)=3/9</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--8-->
                        <td>P("GGC"A)=1/2</td>
                        <td>P("GG"C)=1/2</td>
                        <td>P("G"G)=1/3</td>
                        <td>P(""G)=2/9</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--8-->
                        <td>P("GCA"A)=1/2</td>
                        <td>P("GC"A)=1/2</td>
                        <td>P("G"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--8-->
                        <td> </td>
                        <td>P("CA"A)=1/2</td>
                        <td>P("C"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--8-->
                        <td> </td>
                        <td> </td>
                        <td>P("A"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td><!--8-->
                        <td>1/2,1/2,1/2,<br>1/2,1/2</td>
                        <td>1/2,1/2,1/2,<br>1/2,1/2,1/2</td>
                        <td>1/3,1/2,1/3,<br>1/3</td>
                        <td>P⊗=1/9</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light">
                        <th>9：</th><!--9-->
                        <td> </td>
                        <td>已知"CAA"</td>
                        <td> </td>
                        <td class="t-align-right"><span class="text-blue-emph">CTAGGCAA</span><span class="text-red-emph">T</span>C</td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--9-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 配 T</td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--9-->
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>T</td>
                        <td> </td>
                        <td>"⊗⊗⊗T"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--9-->
                        <td>P⊗ = 1</td>
                        <td>P"CA"⊗ = 1/2</td>
                        <td>P"A"⊗ = 1/3</td>
                        <td>P(""A)=1/9</td>
                        <td> </td>
                        <td>1/2×1/3×<br>1/9</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--9-->
                        <td>P("CTA"G)=1/2</td>
                        <td>P("CT"A)=1/2</td>
                        <td>P("C"T)=1/3</td>
                        <td>P(""C)=2/10</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--9-->
                        <td>P("TAG"G)=1/2</td>
                        <td>P("TA"G)=1/2</td>
                        <td>P("T"A)=1/2</td>
                        <td>P(""T)=2/10</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--9-->
                        <td>P("AGG"C)=1/2</td>
                        <td>P("AG"G)=1/2</td>
                        <td>P("A"G)=1/4</td>
                        <td>P(""A)=3/10</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--9-->
                        <td>P("GGC"A)=1/2</td>
                        <td>P("GG"C)=1/2</td>
                        <td>P("G"G)=1/3</td>
                        <td>P(""G)=2/10</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--9-->
                        <td>P("GCA"A)=1/2</td>
                        <td>P("GC"A)=1/2</td>
                        <td>P("G"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--9-->
                        <td>P("CAA"T)=1/2</td>
                        <td>P("CA"A)=1/3</td>
                        <td>P("C"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--9-->
                        <td> </td>
                        <td>P("CA"T)=1/3</td>
                        <td>P("A"A)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--9-->
                        <td> </td>
                        <td> </td>
                        <td>P("A"T)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td><!--9-->
                        <td>1/2,1/2,1/2,<br>1/2,1/2</td>
                        <td>1/2,1/2,1/2,<br>1/2,1/2,1/3</td>
                        <td>1/3,1/2,1/4,<br>1/3</td>
                        <td>P⊗=1/10</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light">
                        <th>10：</th><!--10-->
                        <td>输入 C</td>
                        <td>已知"AAT"</td>
                        <td> </td>
                        <td class="t-align-right"><span class="text-blue-emph">CTAGGCAAT</span><span class="text-red-emph">C</span></td>
                        <td class="t-align-left">TAGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--10-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 配 C</td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--10-->
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>C</td>
                        <td> </td>
                        <td>"⊗⊗⊗C"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--10-->
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P"T"⊗ = 1/2</td>
                        <td>P(""C)=2/10</td>
                        <td> </td>
                        <td>1/2×2/10</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--10-->
                        <td>P("CTA"G)=1/2</td>
                        <td>P("CT"A)=1/2</td>
                        <td>P("C"T)=1/3</td>
                        <td>P(""C)=3/11</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--10-->
                        <td>P("TAG"G)=1/2</td>
                        <td>P("TA"G)=1/2</td>
                        <td>P("T"A)=1/3</td>
                        <td>P(""T)=2/11</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--10-->
                        <td>P("AGG"C)=1/2</td>
                        <td>P("AG"G)=1/2</td>
                        <td>P("A"G)=1/4</td>
                        <td>P(""A)=3/11</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--10-->
                        <td>P("GGC"A)=1/2</td>
                        <td>P("GG"C)=1/2</td>
                        <td>P("G"G)=1/3</td>
                        <td>P(""G)=2/11</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--10-->
                        <td>P("GCA"A)=1/2</td>
                        <td>P("GC"A)=1/2</td>
                        <td>P("G"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--10-->
                        <td>P("CAA"T)=1/2</td>
                        <td>P("CA"A)=1/3</td>
                        <td>P("C"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--10-->
                        <td>P("AAT"C)=1/2</td>
                        <td>P("CA"T)=1/3</td>
                        <td>P("A"A)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--10-->
                        <td> </td>
                        <td>P("AT"C)=1/2</td>
                        <td>P("A"T)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--10-->
                        <td> </td>
                        <td> </td>
                        <td>P("T"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td><!--10-->
                        <td>1/2,1/2,1/2,<br>1/2,1/2,1/2</td>
                        <td>1/2,1/2,1/2,<br>1/2,1/2,1/3,<br>1/2</td>
                        <td>1/3,1/3,1/4,<br>1/3</td>
                        <td>P⊗=1/11</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light">
                        <th>11：</th><!--11-->
                        <td>输入 T</td>
                        <td>已知"ATC"</td>
                        <td> </td>
                        <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                        <td class="t-align-left"><span class="text-red-emph">T</span>AGGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--11-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td> </td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--11-->
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>T</td>
                        <td> </td>
                        <td> </td>
                        <td>"⊗⊗T"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--11-->
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1</td>
                        <td>P"T"⊗ = 1/3</td>
                        <td> </td>
                        <td> </td>
                        <td>1/3</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--11-->
                        <td>P("CTA"G)=1/2</td>
                        <td>P("CT"A)=1/2</td>
                        <td>P("C"T)=2/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--11-->
                        <td>P("TAG"G)=1/2</td>
                        <td>P("TA"G)=1/2</td>
                        <td>P("T"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--11-->
                        <td>P("AGG"C)=1/2</td>
                        <td>P("AG"G)=1/2</td>
                        <td>P("A"G)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--11-->
                        <td>P("GGC"A)=1/2</td>
                        <td>P("GG"C)=1/2</td>
                        <td>P("G"G)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--11-->
                        <td>P("GCA"A)=1/2</td>
                        <td>P("GC"A)=1/2</td>
                        <td>P("G"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--11-->
                        <td>P("CAA"T)=1/2</td>
                        <td>P("CA"A)=1/3</td>
                        <td>P("C"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--11-->
                        <td>P("AAT"C)=1/2</td>
                        <td>P("CA"T)=1/3</td>
                        <td>P("A"A)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--11-->
                        <td>P("ATC"T)=1/2</td>
                        <td>P("AT"C)=1/2</td>
                        <td>P("A"T)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--11-->
                        <td> </td>
                        <td>P("TC"T)=1/2</td>
                        <td>P("T"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td>
                        <td>1/2,1/2,1/2,<br>1/2,1/2,1/2,<br>1/2</td><!--11-->
                        <td>1/2,1/2,1/2,<br>1/2,1/2,1/3,<br>1/2,1/2</td>
                        <td>1/4,1/3,1/4,<br>1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light">
                        <th>12：</th><!--12-->
                        <td>输入 A</td>
                        <td>已知"TCT"</td>
                        <td> </td>
                        <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                        <td class="t-align-left"><span class="text-blue-emph">T</span><span class="text-red-emph">A</span>GGTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--12-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配 A</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--12-->
                        <td>⊗</td>
                        <td>A</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>"⊗A"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--12-->
                        <td>P⊗ = 1</td>
                        <td>P⊗ = 1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>1/2</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--12-->
                        <td>P("CTA"G)=1/2</td>
                        <td>P("CT"A)=2/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--12-->
                        <td>P("TAG"G)=1/2</td>
                        <td>P("TA"G)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--12-->
                        <td>P("AGG"C)=1/2</td>
                        <td>P("AG"G)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--12-->
                        <td>P("GGC"A)=1/2</td>
                        <td>P("GG"C)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--12-->
                        <td>P("GCA"A)=1/2</td>
                        <td>P("GC"A)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--12-->
                        <td>P("CAA"T)=1/2</td>
                        <td>P("CA"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--12-->
                        <td>P("AAT"C)=1/2</td>
                        <td>P("CA"T)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--12-->
                        <td>P("ATC"T)=1/2</td>
                        <td>P("AT"C)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--12-->
                        <td>P("TCT"A)=1/2</td>
                        <td>P("TC"T)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td><!--12-->
                        <td>1/2,1/2,1/2,<br>1/2,1/2,1/2,<br>1/2,1/2</td>
                        <td>1/3,1/2,1/2,<br>1/2,1/2,1/3,<br>1/2,1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-bottom t-invert-light">
                        <th>13：</th><!--13-->
                        <td>输入 G</td>
                        <td>已知"CTA"</td>
                        <td> </td>
                        <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                        <td class="t-align-left"><span class="text-blue-emph">TA</span><span class="text-red-emph">G</span>GTA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--13-->
                        <td>CTX3 匹配 G</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--13-->
                        <td>G</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>"G"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--13-->
                        <td>P"CTA"G=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>1/2</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--13-->
                        <td>P("CTA"G)=2/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--13-->
                        <td>P("TAG"G)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--13-->
                        <td>P("AGG"C)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--13-->
                        <td>P("GGC"A)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--13-->
                        <td>P("GCA"A)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--13-->
                        <td>P("CAA"T)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--13-->
                        <td>P("AAT"C)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--13-->
                        <td>P("ATC"T)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--13-->
                        <td>P("TCT"A)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td><!--13-->
                        <td>1/3,1/2,1/2,<br>1/2,1/2,1/2,<br>1/2,1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light">
                        <th>14：</th><!--14-->
                        <td>输入 G</td>
                        <td>已知"TAG"</td>
                        <td> </td>
                        <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                        <td class="t-align-left"><span class="text-blue-emph">TAG</span><span class="text-red-emph">G</span>TA</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--14-->
                        <td>CTX3 匹配 G</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--14-->
                        <td>G</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>"G"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--14-->
                        <td>P"CTA"G=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>1/2</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--14-->
                        <td>P("CTA"G)=2/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--14-->
                        <td>P("TAG"G)=2/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--14-->
                        <td>P("AGG"C)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--14-->
                        <td>P("GGC"A)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--14-->
                        <td>P("GCA"A)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--14-->
                        <td>P("CAA"T)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--14-->
                        <td>P("AAT"C)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--14-->
                        <td>P("ATC"T)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--14-->
                        <td>P("TCT"A)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td><!--14-->
                        <td>1/3,1/3,1/2,<br>1/2,1/2,1/2,<br>1/2,1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-bottom t-invert-light">
                        <th>15：</th><!--15-->
                        <td>输入 T</td>
                        <td>已知"AGG"</td>
                        <td> </td>
                        <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                        <td class="t-align-left"><span class="text-blue-emph">TAGG</span><span class="text-red-emph">T</span>A</td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--15-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配⊗</td>
                        <td>CTX0 配 T</td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--15-->
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>T</td>
                        <td> </td>
                        <td>"⊗⊗⊗T"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--15-->
                        <td>P"AGG"⊗=1/2</td>
                        <td>P"GG"⊗ = 1/2</td>
                        <td>P"G"⊗ = 1/3</td>
                        <td>P(""C)=2/11</td>
                        <td> </td>
                        <td>1/2×1/2×<br>1/3×2/11</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--15-->
                        <td>P("CTA"G)=2/3</td>
                        <td>P("CT"A)=2/3</td>
                        <td>P("C"T)=2/4</td>
                        <td>P(""C)=3/12</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--15-->
                        <td>P("TAG"G)=2/3</td>
                        <td>P("TA"G)=1/2</td>
                        <td>P("T"A)=1/3</td>
                        <td>P(""T)=3/12</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--15-->
                        <td>P("AGG"C)=1/3</td>
                        <td>P("AG"G)=1/2</td>
                        <td>P("A"G)=1/4</td>
                        <td>P(""A)=3/11</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--15-->
                        <td>P("GGC"A)=1/2</td>
                        <td>P("GG"C)=1/3</td>
                        <td>P("G"G)=1/3</td>
                        <td>P(""G)=2/11</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--15-->
                        <td>P("GCA"A)=1/2</td>
                        <td>P("GC"A)=1/2</td>
                        <td>P("G"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--15-->
                        <td>P("CAA"T)=1/2</td>
                        <td>P("CA"A)=1/3</td>
                        <td>P("C"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--15-->
                        <td>P("AAT"C)=1/2</td>
                        <td>P("CA"T)=1/3</td>
                        <td>P("A"A)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--15-->
                        <td>P("ATC"T)=1/2</td>
                        <td>P("AT"C)=1/2</td>
                        <td>P("A"T)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--15-->
                        <td>P("TCT"A)=1/2</td>
                        <td>P("TC"T)=1/2</td>
                        <td>P("T"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--15-->
                        <td>P("AGG"T)=1/3</td>
                        <td>P("GG"T)=1/3</td>
                        <td>P("G"T)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>⊗ 概率</td><!--15-->
                        <td>1/3,1/3,1/3,<br>1/2,1/2,1/2,<br>1/2,1/2</td>
                        <td>1/3,1/2,1/2,<br>1/3,1/2,1/3,<br>1/2,1/2</td>
                        <td>1/4,1/3,1/4,<br>1/4</td>
                        <td>P⊗=1/12</td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="t-invert-light">
                        <th>16：</th><!--16-->
                        <td>输入 A</td>
                        <td>已知"GGT"</td>
                        <td> </td>
                        <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                        <td class="t-align-left"><span class="text-blue-emph">TAGTAGGT</span><span class="text-red-emph">A</span></td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr text-green-dyna">
                        <td>CTX 匹配</td><!--16-->
                        <td>CTX3 匹配⊗</td>
                        <td>CTX2 匹配⊗</td>
                        <td>CTX1 匹配 A</td>
                        <td> </td>
                        <td> </td>
                        <td>小计</td>
                    </tr>
                    <tr class="border-lr text-blue-cnsq">
                        <td>编码结果</td><!--16-->
                        <td>⊗</td>
                        <td>⊗</td>
                        <td>A</td>
                        <td> </td>
                        <td> </td>
                        <td>"⊗⊗A"</td>
                    </tr>
                    <tr class="border-lr text-pink-cnsq">
                        <td>概率结果</td><!--16-->
                        <td>P⊗=1/2</td>
                        <td>P⊗ = 1</td>
                        <td>P"T"A = 1/3</td>
                        <td> </td>
                        <td> </td>
                        <td>1/2×1/3</td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("CTA"G)=2/3</td>
                        <td>P("CT"A)=2/3</td>
                        <td>P("C"T)=2/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("TAG"G)=2/3</td>
                        <td>P("TA"G)=1/2</td>
                        <td>P("T"A)=2/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("AGG"C)=1/3</td>
                        <td>P("AG"G)=1/2</td>
                        <td>P("A"G)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("GGC"A)=1/2</td>
                        <td>P("GG"C)=1/3</td>
                        <td>P("G"G)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("GCA"A)=1/2</td>
                        <td>P("GC"A)=1/2</td>
                        <td>P("G"C)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("CAA"T)=1/2</td>
                        <td>P("CA"A)=1/3</td>
                        <td>P("C"A)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("AAT"C)=1/2</td>
                        <td>P("CA"T)=1/3</td>
                        <td>P("A"A)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("ATC"T)=1/2</td>
                        <td>P("AT"C)=1/2</td>
                        <td>P("A"T)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("TCT"A)=1/2</td>
                        <td>P("TC"T)=1/2</td>
                        <td>P("T"C)=1/4</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr">
                        <td>CTX 更新</td><!--16-->
                        <td>P("AGG"T)=1/3</td>
                        <td>P("GG"T)=1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>CTX 更新</td><!--16-->
                        <td>P("GGT"A)=1/2</td>
                        <td>P("GT"A)=1/2</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                    <tr class="border-lr border-bottom">
                        <td>⊗ 概率</td><!--16-->
                        <td>1/3,1/3,1/3,<br>1/2,1/2,1/2,<br>1/2,1/2,1/2</td>
                        <td>1/3,1/2,1/2,<br>1/3,1/2,1/3,<br>1/2,1/2,1/2</td>
                        <td>1/4,1/4,1/4,<br>1/3</td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                    </tr>
                </tbody>
            </table>

            <p>PPM 非常适合推演 DNA 链 的出字概率，因为人类细胞染色体多达 0.5~25 亿端，而上表在全文未知的情况下已经把最优的出字概率分布总结得差不多了。这种以查表推演 Table lookup 是一种计算特性，与之相对的特性是有限状态机推演。</p>

            <h4>有限状态机 Finite-State Machine</h4>
            <div class="row">
                <p id="LR-UD-027" class="col-10">以状态描述程序/机器。如 1~2 间可过渡出无限个数字，代表机械运动到位的中间过程；去掉过程后（如取整后）剩下圆圈数字表示的①↔②两种状态，就足以抽象地表示按动式圆珠笔；将两态联系起来的操作表示为箭头，即按下笔的按钮，而输出就是下一状态。若需要将笔伸出（需②）而笔已收拢则写作 ①→⓶；若需收拢而笔已伸出则 ②→⓵</p>
                <img src="files/image37.png" alt="Double Action Ball Point Pen" id="LR-UD-028" class="img-small img-right col-2 mb-auto" >
            </div>
            <div class="align-items-center">
                <img src="files/image38.png" alt="Finite State Machine on Double Action Pen" class="img-medium" >
            </div>
            
            <h4>上下文自适应 - 有限状态机推演法</h4>
            <p>BAC 下只有最大概符 Most-probable symbol MPS 和最小概符 Least-probable symbol LPS 两个变量。若大概符（超过 50%）为 1，则 LPS 变量为 0。若已知出 0 概率为 <span class="text-blue-math">\(p0\)</span>，则出 1 的概率就是 <span class="text-blue-math">\(1-p0\)</span>，这样只需要推演 LPS 一个变量的上下文就足以推演 0~1 概率区间的分布。具体分布由人工筛选，所以具体逻辑要看编码器源码，x264 中大体为输入 LPS 为 0/为 1 时的状态切换：若大于 0.5 则变成 MPS，LPS 最小为 0.01875；MPS 最大为 0.98125</p>
            <div class="align-items-center">
                <img src="files/image39.png" alt="Finite State Machine Context Adaptation" class="img-medium" >
            </div>

            <h4>(低精度) 二进制算数编码 Binary Arithmetic Coding BAC</h4>
            <p>通过 MPS，LPS 变量简化出字概率的统计。再降精度到 1/2 的幂（如 8 则在 0~1 区间精确到 1/256 个位深过渡）来略增误差优化性能，再加一步将像素值转二进制的编码，设以便统计过程中交换值，而算数编码的部分不变，就实现了二进制的算数编码。</p>

            <h4>几何分布/等差等比分布类 Geometric distribution</h4>
            <p>条件过程不变，各个尝试独立，只有阴阳两结果的伯努利试验中统计 n 遍成功的概率分布所形成的概率变化曲线，为：<span class="text-blue-math">\[ P(X=x) = (1-p)^{x-1} p \]</span>其中概率 <span class="text-blue-math">\(1-p\)</span> 盖失败，<span class="text-blue-math">\(p\)</span> 盖成功。如：</p>
            <ol>
                <li>尝试 3 次后得阳结果记作"阴，阴，阳"。<span class="text-blue-math">\(P(X=3)=(1-p)(1-p)(p)=(1-p)^{3-1} p\)</span>。</li>
                <li>成功概率为 90% 则记做 <span class="text-blue-math">\( P(X=x) = (1-0.9)^{x-1} (0.9) \)</span>，且成功概率与尝试次数独立</li>
                <li>所谓「重试 3 次后过关」是可能脱离实际的期望值 eXpectation，记做大写 X：<span class="text-blue-math">\( X(x) = \frac{1}{p} \)</span></li>
            </ol>
            <ul>
                <li>小概率对时，一遍对的概率被其它次数分走，而反过来大概率对时，一遍对的概率会夺走其它次数的概率</li>
                <li>因为尝试次数间的差距皆为整数 1（如不存在 0.3 次尝试）所以等差</li>
                <li>因为尝试次数每次都乘进同个 <span class="text-blue-math">\(1-p\)</span> 比率，所以等比</li>
                <li>综上所述（计算过程含多次 <span class="text-blue-math">\(1-p\)</span> 相乘）二维坐标系中可见概率的指数递减下降变化，得名几何分布</li>
            </ul>

            <h4>小数取整法，进位法以及取模</h4>
            <table class="align-items-center table-center">
                <thead>
                <tr>
                    <th class="px-1">名称</th>
                    <th class="px-1">所谓</th>
                    <th class="px-1">运算</th>
                </tr>
                </thead>
                <tbody>
                <tr class="t-light-gray">
                    <td class="px-1">round</td>
                    <td class="px-1">舍入</td>
                    <td class="px-1">四舍五入</td>
                </tr>
                <tr>
                    <td class="px-1">celling <span class="text-blue-math">\( \lceil x \rceil \)</span></td>
                    <td class="px-1">取上</td>
                    <td class="px-1">进位法</td>
                </tr>
                <tr class="t-light-gray">
                    <td class="px-1">floor <span class="text-blue-math">\( \lfloor x \rfloor \)</span></td>
                    <td class="px-1">取下</td>
                    <td class="px-1">去尾法</td>
                </tr>
                <tr>
                    <td class="px-1">modulus</td>
                    <td class="px-1">取模</td>
                    <td class="px-1">余数乘以除数</td>
                </tr>
                </tbody>
            </table>
            
            <h4>转二进制 - 伪哥伦布编码</h4>
            <p>8bit 下，十进制 3 会转为浪费码率的 00000011——因为前后都挨着其它 8bit 数而不能删；所以添加清点有效位数的标记，共有 11 两位数而设标记 00，再转后缀为前缀，就得到相对可靠的 <span class="text-blue-math">\( (a=00,b=11) \)</span>；解码器识别出变量 a，b，为两位数的二进制 11 而还原</p>

            <h4>转二进制 - 一元码 Unary，截短二进制码 Truncated Binary</h4>
            <p>一元码如 2，3 即<span class="text-blue-math">110</span>，<span class="text-blue-math">1110</span>或<span class="text-blue-math">001</span>，<span class="text-blue-math">0001</span>，末尾分隔后续数，差在吃带宽。截短二进制如 8bit 的十进制 5 是二进制<span class="text-blue-math">00000101</span>。所以能截短到<span class="text-blue-math">101</span>，但问题是多个数字放一起就难以解码。</p>

            <h4>转二进制 - 哥伦布 (-莱斯) 编码 Golomb(-Rice) Coding</h4>
            <p>将正整数转二进制并压缩。以输入 N，十进制缩放值 M 与刻度 Κ，一元码，截短二进制实现。（-莱斯）码在此基础上限制 M 仅为 2 的幂，对计算机更友好。此处例 M=4，输入 N=9：</p>
            <ol>
                <li>㏒<sub>2</sub>缩放的刻度 K：<span class="text-blue-math">Kλίμακα \( = \lceil \log_{2} M \rceil \)</span>，如 <span class="text-blue-math">\(\log_{2}{4}=2\)</span>，ceil 约 2
                    <ul class="text-gray-side">
                        <li>注：译作刻度 klimaka，但 k 实际是公认随便写的刻度变量</li>
                    </ul>
                </li>
                <li>求商去尾，转一元码：<span class="text-blue-math">\(Quotient = \text{Unary} \left\lfloor \frac{N}{M} \right\rfloor\)</span>，如 <span class="text-blue-math">\(9 \div 4 = 2.25\)</span>，floor 约 2，换一元码 110</li>
                <li>求余数模，判断区间：<span class="text-blue-math">\(\text{Remainder} = N \ \% \ M\)</span>，如 <span class="text-blue-math">\(9 \% 4 = 9 - (\lfloor9 \div 4 \rfloor \times 4) = 1\)</span></li>
                <li>余数模是否小于刻度：<span class="text-blue-math">\(0 \leq R &lt; (2^K - M) ? \)</span>，如 <span class="text-blue-math">\(0\leq 1 &lt; (2^2 - 4)\)</span> 结果否定，因为 <span class="text-blue-math">\(2^2 - 4 = 0\)</span>
                <span class="text-blue-math text-smaller">\[R\prime = \begin{cases} 
                \text{turnc}(R) \text{ in } (K-1) \text{ bits,} & 0 \leq R &lt; (2^K-M) \\
                \text{turnc}(R+2^K-M) \text{ in } K \text{ bits,} & R \geq (2^K-M)
                \end{cases} \]</span>
                    <ol class="text-gray-side">
                        <li>小于刻度则用 K-1 个 bit 的长度编码：<span class="text-blue-math">\(R\prime = trunc(R) \text{ in } (K-1) \text{ bits}\)</span></li>
                        <li>大于等于则用 K 个 bit 的长度编码：<span class="text-blue-math">\(R\prime = \text{turnc}(R + 2^K - M) \text{ in Kbits}\)</span></li>
                        <li>简单说，判断输入 N 是否位于「二进制前半」，如 2bit 下，00，01，10，11 的前半 00，01 可省去首位 0</li>
                    </ol>
                </li>
            </ol>
            <div class="align-items-center">
                <img src="files/image40.png" alt="Golomb Rice Coding 2^K-M Variations" class="img-medium" >
                <p class="text-gray-side">图：M=1~32 时，<span class="text-blue-math">\(2^K - M\)</span> 的边界变化，见<a href="https://www.desmos.com/calculator/2gonwxfc1m">Desmos 例</a></p>
            </div>

            <h4>转二进制 - 零阶指数哥伦布编码 Exponential Golomb k0</h4>
            <p>十进制数添一位则量增十倍，如 1，10，100 按×10 倍增；二进制数添一位则量增二倍，如 001，010，100 照×2 倍增。可见「刻度本是指数」，二进制刻度 K 的间距设为指数增加的<span class="text-blue-math">0,1,3,7,15…</span>或<span class="text-blue-math">0,1,11,111,1111…</span>，每度从底<span class="text-blue-math">\(2^{(M-1)}\)</span>延伸至顶<span class="text-blue-math">\(2^{(M+1)}-1\)</span>。刻度 Kλίμακα 设为对齐小的边界：</p>
            <ol>
                <li>设定要编码的 N 并获取其二进制值 +1 为刻度后端。如输入 N=6，则二进制 N = 110</li>
                <li>求二进制刻度 K'：<span class="text-blue-math">\(K\prime = \left\lfloor \log_2 (N+1) \right\rfloor\)</span>。如输入 N=6，则 <span class="text-blue-math">\(\log_{2} (6+1) = 2.81...\)</span>，floor 约 2</li>
                <li>求刻度内偏移值：<span class="text-blue-math">\(Offset = N + 1 - 2^{K\prime}\)</span>，如输入 N=6，则<span class="text-blue-math">\(6+1-2^2=3\)</span>，代表在刻度 6 处偏移 3 下
                    <ol class="text-gray-side">
                        <li class="text-xs">输入 N=0~31 时，十进制 K'=[0,<span class="text-red-emph">1,1,</span><span class="text-blue-emph">2,2,2,2,</span><span class="text-purple-resv">3,3,3,3,3,3,3,3,</span>4,4,4,4,4,4,4,4,4,4, 4, 4, 4, 4, 4, 4]</li>
                        <li class="text-xs">输入 N=0~31 时，十进制 O =[0,<span class="text-red-emph">0,1,</span><span class="text-blue-emph">0,1,2,3,</span><span class="text-purple-resv">0,1,2,3,4,5,6,7,</span>0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]</li>
                        <li>注：O 就是单纯随 K'指数增加而累计偏移量</li>
                    </ol>
                </li>
                <li>K' 值转换为 0 的数量，设为前端 1。如输入 N=6，则 K'=2，则写作 00</li>
                <li>R 值转换二进制为前端 2。前端 1+ 后端 <span class="text-blue-math">\(\text{concat}(Offset_1,K\prime)\)</span> 是常见的零阶指数哥伦布码</li>
                <li>前端 2+ 后端 <span class="text-blue-math">\(\text{concat}(Offset_2,K\prime)\)</span></li>
            </ol>
            <p class="text-gray-side">注：此处因篇幅，难度和不相关而省略一阶及更高阶的哥伦布码</p>
            
            <table class="align-items-center table-center">
                <thead>
                    <tr>
                        <th class="px-1">N</th>
                        <th class="px-1">K'</th>
                        <th class="px-1">R</th>
                        <th class="px-1">前端 1</th>
                        <th class="px-1">后端</th>
                        <th class="px-1">前端 2</th>
                    </tr>
                </thead>
                <tbody>
                    <tr  class="t-light-gray">
                        <td class="px-1">0</td>
                        <td class="px-1">0</td>
                        <td class="px-1">0</td>
                        <td class="px-1"> </td>
                        <td class="px-1">1</td>
                        <td class="px-1">0</td>
                    </tr>
                    <tr>
                        <td class="px-1">1</td>
                        <td class="px-1">1</td>
                        <td class="px-1">0</td>
                        <td class="px-1">0</td>
                        <td class="px-1">10</td>
                        <td class="px-1">0</td>
                    </tr>
                    <tr class="t-light-gray">
                        <td class="px-1">2</td>
                        <td class="px-1">1</td>
                        <td class="px-1">1</td>
                        <td class="px-1">0</td>
                        <td class="px-1">11</td>
                        <td class="px-1">1</td>
                    </tr>
                    <tr>
                        <td class="px-1">3</td>
                        <td class="px-1">2</td>
                        <td class="px-1">0</td>
                        <td class="px-1">00</td>
                        <td class="px-1">100</td>
                        <td class="px-1">00</td>
                    </tr>
                    <tr class="t-light-gray">
                        <td class="px-1">4</td>
                        <td class="px-1">2</td>
                        <td class="px-1">1</td>
                        <td class="px-1">00</td>
                        <td class="px-1">101</td>
                        <td class="px-1">01</td>
                    </tr>
                    <tr>
                        <td class="px-1">5</td>
                        <td class="px-1">2</td>
                        <td class="px-1">2</td>
                        <td class="px-1">00</td>
                        <td class="px-1">110</td>
                        <td class="px-1">10</td>
                    </tr>
                    <tr class="t-light-gray">
                        <td class="px-1">6</td>
                        <td class="px-1">2</td>
                        <td class="px-1">3</td>
                        <td class="px-1">00</td>
                        <td class="px-1">111</td>
                        <td class="px-1">11</td>
                    </tr>
                    <tr>
                        <td class="px-1">7</td>
                        <td class="px-1">3</td>
                        <td class="px-1">0</td>
                        <td class="px-1">000</td>
                        <td class="px-1">1000</td>
                        <td class="px-3">000</td>
                    </tr>
                </tbody>
            </table>

            <h4>汉明距离与欧几里得距离</h4>
            <p>前者在不考虑大小的情况下测量数字信号的差距，如<span class="text-blue-math">100</span>与<span class="text-blue-math">010</span>的汉明距离为 2，可累计各位数的异或门 ⊻ 得到，构成误差和 SAD；后者测量两个点的平方差 SSE，如 GPS 的地理误差。</p>

            <h4>软判决与硬判决解码 Soft/Hard Decision decoding</h4>
            <p>尝试解决以下问题的两种方法，其中软判决最优：</p>
            <ol>
                <li>假设二进制 0 为<span class="text-blue-math">0.33V</span>，1 为<span class="text-blue-math">0.67V</span>；再定义编解码格式的有效字为<span class="text-blue-math">[001,010,100,101,111]</span></li>
                <li>传输码字<span class="text-blue-math">001</span>，电压为<span class="text-blue-math">0.33,0.33,0.67V</span></li>
                <li>结果，解码器得到偏移的<span class="text-blue-math">0.35V,0.55V,0.75V</span></li>
            </ol>
            <p>硬判决：设置大于<span class="text-blue-math">0.4V</span>则 1；小于<span class="text-blue-math">0.5V</span>则 0。得<span class="text-blue-math">0,1,1</span>。比对有效字，汉明距离为<span class="text-blue-math">[1,1,3,2,1]</span>，共 3 个误差最小的可能</p>
            <p>软判决：比对电压间的平方差，如同样的偏移值，对比<span class="text-blue-math">001</span>算：</p>
            <span class="text-blue-math">\[\left(0.33-0.35\right)^2 + \left(0.35-0.55\right)^2 + \left(0.67-0.75\right)^2 = 0.0468\]</span>
            <p>对比<span class="text-blue-math">[010，100，…]</span>分别得欧几里得距离为<span class="text-blue-math">[0.1912,0.3272,0.1572,…]</span>等远大于<span class="text-blue-math">0.0468</span>的误差，就在条件不变的情况下更准确的解码了信息。</p>

            <h4>游程/游标编码 Run-length/run-level coding</h4>
            <p></p>
            <div class="align-items-center">
                <img src="files/image41.png" alt="Run Length Coding Demonstration" class="img-medium" >
            </div>

            <h4>Trellis</h4>
            <p>原指北欧建筑的白墙木条棋盘格子装修。在动态规划编程 Dynamic programming 中代表过程的可视化——各状态为节点，且都遵循一种从左推演到右的规则而相互连成的网格，视频编码中包括：</p>
            <ul>
                <li>Psy-trellis 心理学优化，于 x264 的 --psy-rd</li>
                <li>Viterbi-trellis，解决最短路径，隐马尔科夫问题的导航寻路算法，用于推演 B 帧位置</li>
                <li>Trellis-coded quantization（TCQ，h.263+，trellis 卷积内核的有限状态机）中涉及的量化优化，停留在理论</li>
                <li>软判决率失真优化 CABAC 的再量化，于 x264 --trellis 参数</li>
            </ul>

            <h4>软判决率失真优化 CABAC 的再量化-SDQ trellis</h4>
            <p>算数编码行游标编码之倒序——先编码最大概率的 0，后编码低概的绝对值强度 absolute level（因为含负强度/DCT 系子波形的反相）。得从各个可能路线整合出 trellis 所有上下文可能性以及变更（如下图）。由于文本编码是动态程序（一次编一字），所以路线一次只能改一条，且会保持出字概率而得斜线。</p>
            <div class="align-items-center">
                <img src="files/image42.png" alt="Soft Decision Quantization Trellis Chart" class="img-medium" ><br>
            </div>
            <p>4x4 块的 16 个倒序 zig-zag 系子中，预测与总结系子强度（等于 1_大于 1，或<span class="text-blue-math">NumEq1_NumLg1</span>）的数量归纳为 8 种 CABAC 上下文长度的节点（0_0~any_any），如 2_0 对应<span class="text-blue-math">NumLg1×2</span>，<span class="text-blue-math">NumEq1×1</span>，即 2_0 线。</p>
            <p>若<span class="text-blue-math">NumLg1 &gt; 0</span>，则从当前系子节点切到下个系子的 ×_1 线并不再回到<span class="text-blue-math">NumEq1</span></p>
            <p>若<span class="text-blue-math">NumLg1≥4</span>则构成 any_any 或 x_x，若<span class="text-blue-math">(NumEq1≥4 && NumLg1==0)</span>时则构成 any_0 或 x_0，为两种上下文长 4(最大) 的 CABAC 路线，一种只编码 0 和 1，另一种编码 0，1，&lt;其它&gt;。各线路上的率即强度 level，失真就是其系子节点平方差 SSE，而率失真最优的线路就是 SSE（失真）+ λ⋅R（码率）最小的线路</p>
            <p>叫软判决量化是因为此处 SSE 测了欧几里得距离，相对的硬判决量化为 qp 值所对应的 DCT 除法表。</p>

            <h2>SEI 补充与优化消息</h2>
            <p>Supplemental enhance info 记录每帧的补充信息。主要有正确解码新 GOP 用的缓冲 SEI，解码校正时间戳的 pic timing SEI，让显示主控切边的 SEI，cc 字幕 SEI，HDR-SEI 等等。缓冲 SEI 记录对应 SPS 的号；待解码图像缓冲 Coded picture buffer CPB 的延迟安全区等信息；时戳 SEI 记录哪些帧上/下场优先的变化；连帧/三连帧的位置等信息。</p>

            <pre class="mb-0"><code><b>--hrd</b>&lt;开关，默认关，<span class="text-red-emph">需开vbv</span>&gt;
将假设对照解码参数Hypothetical Reference Decoder Parameter估计不丢包无延迟的瞬间码率，写在每段SPS及SEI里，对专门配置了网络串流，NAS播放自动缓冲的播放器有好处
<b>--hash</b>&lt;整数0~3，默认0/关&gt;SEI里加效验码，播放时可用以对图像重建纠错来减少失真，但校验本身会消耗算力：
    · <span class="text-blue-emph">1</span>：checksum校验，性能占用最小
    · <span class="text-blue-emph">2</span>：CRC校验，性能占用略高，准确率较高，一般情况推荐
    · <span class="text-blue-emph">3</span>：CRC校验，性能占用略高，准确率高；性能占用高
<b>--single-sei</b>&lt;开关&gt;只写一个装全部SEI信息的大NALU而非每GOP都写，提高很小一点压缩率，但可能会降低兼容性
<b>--film-grain</b>&lt;文件名&gt;将如<a href="https://bitbucket.org/multicoreware/libfgm">libfgm</a>提取的纹理细节模型Film grain model写进SEI，将编码压缩掉的细节另存档，兼容解码器播放时恢复的功能
<b>--idr-recovery-sei</b>&lt;开关&gt;SEI写进idr帧，串流时防止整个GOP都找不到参考帧的机制
<b>--frame-dup</b>&lt;开关，默认关，需<span class="text-red-emph">开vbv和hrd，有bug</span>&gt;直接将2~3面极近似的连续帧换成同一帧并用SEI告知，理论上能在动漫和电脑录屏画面提高压缩率，但会降低兼容性
<b>--dup-threshold</b>&lt;整数1~99，默认70&gt;相似度判定值，默认达70%重复就判为相似</code></pre>

            <h2>线程与节点控制</h2>
            <h4>设置创建比电脑处理器更多的线程会不会更快</h4>
            <p>每个 CPU 线程能占用的算力最高只有 100%，因此会导致处理器随机并发的特性，从任务数量上冲淡如参考帧建立等需要之前步骤算完才能开始运行的时间窗口，造成编码器跳过一部分参考压缩，码率增加，画质降低。</p>

            <h4>买淘汰线程撕裂者跑压制的可行性</h4>
            <p>由于线程撕裂者 1000~2000 系处理器是用多个节点拼出来的（可能部分 EPYC 处理器也是这样？），所以单处理器内部就是多个 CPU 节点。此外要避开 2990WX 与 2970WX（核心组 1，3 没有内存控制器用，所以只能用 0，2）</p>

            <h4>X3D 处理器在压制上是否有优势</h4>
            <p>见 <a href="https://www.pugetsystems.com/labs/articles/amd-ryzen-5800x3d-vs-5800x-for-content-creation-2331/">PugetSystems 跑分</a>：</p>
            <ul>
                <li>Cinebench 与 Unreal Engine 5 跑分上，Ryzen 7 5800X 比 Ryzen 7 5800X3D 快了近 10%，原因是 X3D 缓存限制了处理器的散热，因此频率变低，算力降低了</li>
                <li>Lightrooms 等单图处理上 Ryzen 7 5800X3D 跑分超过了 Ryzen 7 5800X，因为滤镜所占的缓存较高，普通处理器的算力受到缓存限制而发挥不出来</li>
                <li>Photoshop 2022，After Effects，Premiere Pro，DaVinci 上 Ryzen 9 5900 X，Ryzen 7 5800X3D，Ryzen 7 5800X 持平，可能是内存瓶颈或优化不足导致</li>
                <li>然而以上大部分测试中真正领先的是 i9 12900K（S），除了 Unreal Engine 5 和 V-Ray 中 Ryzen 7 5950X 领先一次，因为大小核架构提升了多核性能</li>
            </ul>
            <p>由此可见，持续地高负载下算力比较重要，间接高负载下缓存内存比较重要，同时还要带宽足够大的内存，优化到位的软件和系统才能将性能发挥出来。压制大部分情况下是需要多核性能的持续高负载，因此 X3D 处理器没有优势。尽管这种高负载可能只占很少的使用场景（如大部分时间作游戏机使用）</p>

            <h4>多节点/多路主机</h4>
            <p>如电脑连接超过一台打印机，超过一个网卡（如有线 + 无线）就称为多节点部署。此处特指 CPU 节点——同主板上超过一颗处理器以及其对应内存的系统环境。这种环境的缺点是节点 0 的处理器访问节点 1 的内存的延迟很大，所以一般通过虚拟机，或专门优化的程序来限制软件只占用一个节点的 CPU 核心。</p>
            <pre class="mb-0"><code><b>--pools</b>&lt;整数/加减符,,,，默认*（占用任意节点电脑的全部线程）&gt;x264中--threads的升级版。+代表全部处理器线程，-代表不使用处理器，数字代表占用多少个线程；
例如<span class="text-blue-emph">pools +,-,-,-</span>表明电脑有4个CPU节点，用其首
设为<span class="text-blue-emph">pools none</span>时关闭
单节点系统无需关心，或设置如<span class="text-blue-emph">pools 8</span>占用处理器的8个线程
注：若--wpp，--pmode，--pme，--lookahead-slices全关，则--pools参数无效
注：若指定--pools none，则--wpp，--pmode，--pme，--lookahead-slices无效
<b>--pmode</b>&lt;开关，x265官方建议rd 3/5占不满算力的情况下开&gt;并行模式决策，提高多核心占用但相对难以统一处理噪点</code></pre>

            <h4>线程池 Threadpool</h4>
            <p>同网络下全电脑的所有可用线程，或此处所有节点 CPU 线程的数量。若 x265 占用超过 64 个线程（32bit 系统下为 32 个），则这些线程本身还可以细分出最多 64 个子线程（32bit 系统下为 32 个）。子线程池的大小和 pool 参数设置出的大小一致，但因为性能和系统兼容性的限制，子线程可能会比预期少。</p>

            <h4>工作者线程/分工线程-Worker thread</h4>
            <p>一种多线程优化，能部分解决跨节点运行性能问题——主程序分出一个活跃的分工线程持续重复执行任务，如监听端口 8080，监听信息的后台进程；或者是 x265 外包任务给其它核心或节点上的 pme/pmode Worker thread，使 x265 可以略好的跨节点运行。</p>
            <pre class="mb-0"><code><b>--pmode</b>&lt;开关，默认关，<span class="text-red-emph">需pools</span>&gt;创建平行模式决策Parallel Mode Decision的Worker thread以更改pools参数功能。推荐先于pme打开，推荐搭配rd 3 + rect，而rd 5时可以先确认占用率未跑满再打开。
    · 如<span class="text-blue-emph">--pme --pmode</span>表明使用整个线程池，分配平行动态搜索，平行模式决策以更好地增加多线程节点占用。
    · 模式决策独立线程化会使本可提前退出的策略因信息孤立而不可跳过，使理论率失真最优推理更准（无损压缩略微提升）
<b>--pme</b>&lt;开关，默认关，<span class="text-red-emph">需pools</span>&gt;创建平行动态搜索Parallel Motion Estimation的Worker thread以更改pools参数功能（不影响输出文件）。
    · 如<span class="text-blue-emph">--pme</span>表明使用整个线程池，并分配平行动态搜索的分工线程
    · 开pme时，遇到性能（比仅一个节点）更差状况的可能性不低</code></pre>

            <h4>多线程 vs 多参考（frame-thread）</h4>
            <p>用多线程一次编码多帧来占满算力 vs 一次只编一帧，确保所有参考画面可用（大幅提高多核占用，画质和文件影响小）的决策。造成多线多参考帧困难的原因有：</p>
            <ul class="text-gray-side">
                <li>CTU 的面积比宏块大，其中画面变化的概率增加</li>
                <li>参考前要等环路滤波，率失真优化，以及已编码信息的依赖，使得很多参考（特别是高 ref）来不及找而被跳过</li>
            </ul>
            <p>因此有了“每帧线程”的并行编码帧数量分配概念。关--wpp 时，frame-thread 参数设为<span class="text-blue-math">\(\min(\text{cpuCount},\frac{\text{ctuRows}}{2})\)</span>，开则为下表：</p>
            <table class="table-center align-items-center">
                <thead>
                    <tr>
                        <th class="px-3">Cores</th>
                        <th class="px-3">Frames</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="t-light-gray">
                        <td class="px-3">&gt; 32</td>
                        <td class="px-3">6..8</td>
                    </tr>
                    <tr>
                        <td class="px-3">&gt;= 16</td>
                        <td class="px-3">5</td>
                    </tr>
                    <tr class="t-light-gray">
                        <td class="px-3">&gt;= 8</td>
                        <td class="px-3">3</td>
                    </tr>
                    <tr>
                        <td class="px-3">&gt;= 4</td>
                        <td class="px-3">2</td>
                    </tr>
                </tbody>
            </table>

            <pre><code><b>--frame-threads</b>&lt;整数0~16~线程数÷2，默认0自动&gt;同时压制多少帧：
    · 如<span class="text-blue-emph">1</span>能让编码器做到前后整帧可完全分析参考，设1的代价是cpu占用显著降低，压制显著减速，建议搭配mcstf使用
    · 非<span class="text-blue-emph">1</span>则因为编码顺序，只有ctu下方的一行ctu可供参考，损失一半可能的参考范围</code></pre>

            <h2>色彩空间转换，VUI/HDR 信息，黑边跳过</h2>
            <p>写错或忘写也可以改的元数据。HDR 电视只读取 maxcll 和 maxfall，所以实际情况是 master-display 可略。光强/光压单位 Candela 等于尼特，即<span class="text-blue-math">\(1 \text{cd} = 1 \text{nit}\)</span>。因 bt601，709，HDR-PQ，HLG 标准重视的亮度范围，曲线所异（偏亮或偏暗），故需要量化曲线，心理学优化，模式决策的重适配。色彩格式的具体转换变量与算法标准见下表（<a href="https://www.itu.int/rec/dologin.asp?lang=s&id=T-REC-H.265-201504-S!!MSW-E">T-Rec 建议</a>的 Table E.3 所在处，2015 版为 p347~353 的 5~6 页）：</p>
            <table class="table-center text-smaller">
                <thead class="thead-no-border">
                    <tr class="t-invert-dark">
                        <th class="px-1">值</th>
                        <th class="px-1">原色系</th>
                        <th class="px-1"></th>
                        <th class="px-1"></th>
                        <th class="px-1">注解</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-bottom">
                        <td class="px-1">0</td>
                        <td class="px-1">Reserved</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                        <td class="px-1">国际电信联盟 - 电信标准化部门（ITU‑T） | ISO/IEC 占位留以后用</td>
                    </tr>
                    <tr>
                        <td class="px-1">1</td>
                        <td class="px-1">原色 primary</td>
                        <td class="px-1">x</td>
                        <td class="px-1">y</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.709-5</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">绿</td>
                        <td class="px-1">0.3</td>
                        <td class="px-1">0.6</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.1361 常规色域系统，扩展色域系统</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">蓝</td>
                        <td class="px-1">0.15</td>
                        <td class="px-1">0.06</td>
                        <td class="px-1">国际电工委员会（IEC）61966-2-1（sRGB 或 sYCC）</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">红</td>
                        <td class="px-1">0.64</td>
                        <td class="px-1">0.33</td>
                        <td class="px-1">国际电工委员会（IEC）61966-2-4</td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="px-1"> </td>
                        <td class="px-1">白点 D65</td>
                        <td class="px-1">0.313</td>
                        <td class="px-1">0.329</td>
                        <td class="px-1">电影电视工程师协会（SMPTE）RP 177（1993）——Annex B</td>
                    </tr>
                    <tr>
                        <td class="px-1">2</td>
                        <td class="px-1">未标注 Unspecified</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                        <td class="px-1">特征未标注，或设为由应用程序确定</td>
                    </tr>
                    <tr>
                        <td class="px-1">3</td>
                        <td class="px-1">保留值 Reserved</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                        <td class="px-1">国际电信联盟 - 电信标准化部门（ITU‑T） | ISO/IEC 占位留以后用</td>
                    </tr>
                    <tr>
                        <td class="px-1">4</td>
                        <td class="px-1">原色 primary</td>
                        <td class="px-1">x</td>
                        <td class="px-1">y</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.470‑6 System M（历史遗留）</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">绿</td>
                        <td class="px-1">0.21</td>
                        <td class="px-1">0.71</td>
                        <td class="px-1">美国国家电视系统委员会（1953），彩色电视传输标准建议</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">蓝</td>
                        <td class="px-1">0.14</td>
                        <td class="px-1">0.08</td>
                        <td class="px-1">美国联邦通信委员会（2003），美国联邦法规 47 章 73.682</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">红</td>
                        <td class="px-1">0.67</td>
                        <td class="px-1">0.33</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="px-1"> </td>
                        <td class="px-1">白点 C</td>
                        <td class="px-1">0.31</td>
                        <td class="px-1">0.316</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1">5</td>
                        <td class="px-1">原色 primary</td>
                        <td class="px-1">x</td>
                        <td class="px-1">y</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.470‑6 System B，G（历史遗留）</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">绿</td>
                        <td class="px-1">0.29</td>
                        <td class="px-1">0.6</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.601‑6 625</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">蓝</td>
                        <td class="px-1">0.15</td>
                        <td class="px-1">0.06</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.1358 625</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">红</td>
                        <td class="px-1">0.64</td>
                        <td class="px-1">0.33</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.1700 625 PAL，625 SECAM</td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="px-1"> </td>
                        <td class="px-1">白点 D65</td>
                        <td class="px-1">0.313</td>
                        <td class="px-1">0.329</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1">6</td>
                        <td class="px-1">原色 primary</td>
                        <td class="px-1">x</td>
                        <td class="px-1">y</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.601‑6 525</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">绿</td>
                        <td class="px-1">0.31</td>
                        <td class="px-1">0.595</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.1358 525</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">蓝</td>
                        <td class="px-1">0.155</td>
                        <td class="px-1">0.07</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.1700 NTSC</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">红</td>
                        <td class="px-1">0.63</td>
                        <td class="px-1">0.34</td>
                        <td class="px-1">电影电视工程师协会（SMPTE）170M（2004）</td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="px-1"> </td>
                        <td class="px-1">白点 D65</td>
                        <td class="px-1">0.313</td>
                        <td class="px-1">0.329</td>
                        <td class="px-1">（功能与值 7 所同）</td>
                    </tr>
                    <tr>
                        <td class="px-1">7</td>
                        <td class="px-1">原色 primary</td>
                        <td class="px-1">x</td>
                        <td class="px-1">y</td>
                        <td class="px-1">电影电视工程师协会（SMPTE）240M（1999）</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">绿</td>
                        <td class="px-1">0.31</td>
                        <td class="px-1">0.595</td>
                        <td class="px-1">（功能与值 6 所同）</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">蓝</td>
                        <td class="px-1">0.155</td>
                        <td class="px-1">0.07</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">红</td>
                        <td class="px-1">0.63</td>
                        <td class="px-1">0.34</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">white D65</td>
                        <td class="px-1">0.313</td>
                        <td class="px-1">0.329</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1">8</td>
                        <td class="px-1">原色 primary</td>
                        <td class="px-1">x</td>
                        <td class="px-1">y</td>
                        <td class="px-1">普通胶片电影（国际照明委员会 CIE 光源 C 滤镜）</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">绿（Wratten 58）</td>
                        <td class="px-1">0.243</td>
                        <td class="px-1">0.692</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">蓝（Wratten 47）</td>
                        <td class="px-1">0.145</td>
                        <td class="px-1">0.049</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">红（Wratten 25）</td>
                        <td class="px-1">0.681</td>
                        <td class="px-1">0.319</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="px-1"> </td>
                        <td class="px-1">白点 C</td>
                        <td class="px-1">0.31</td>
                        <td class="px-1">0.316</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1">9</td>
                        <td class="px-1">原色 primary</td>
                        <td class="px-1">x</td>
                        <td class="px-1">y</td>
                        <td class="px-1">国际电信联盟 - 无线电通信部门（ITU‑R）BT.2020</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">绿</td>
                        <td class="px-1">0.71</td>
                        <td class="px-1">0.797</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">蓝</td>
                        <td class="px-1">0.131</td>
                        <td class="px-1">0.046</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">红</td>
                        <td class="px-1">0.708</td>
                        <td class="px-1">0.292</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="px-1"> </td>
                        <td class="px-1">白点 D65</td>
                        <td class="px-1">0.313</td>
                        <td class="px-1">0.329</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1">10</td>
                        <td class="px-1">原色 primary</td>
                        <td class="px-1">x</td>
                        <td class="px-1">y</td>
                        <td class="px-1">电影电视工程师协会（SMPTE）ST 428-1</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">Y</td>
                        <td class="px-1">0</td>
                        <td class="px-1">1</td>
                        <td class="px-1">（国际照明委员会 CIE 1931 XYZ）</td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">Z</td>
                        <td class="px-1">0</td>
                        <td class="px-1">0</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1"> </td>
                        <td class="px-1">X</td>
                        <td class="px-1">1</td>
                        <td class="px-1">0</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="px-1"> </td>
                        <td class="px-1">中心白点 centre white</td>
                        <td class="px-1">1÷3</td>
                        <td class="px-1">1÷3</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr>
                        <td class="px-1">11~255</td>
                        <td class="px-1">保留值 Reserved</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                        <td class="px-1">国际电信联盟 - 电信标准化部门（ITU‑T） | ISO/IEC 占位留以后用</td>
                    </tr>
                </tbody>
            </table>

            <h4>高动态范围 High Dynamic Range HDR</h4>
            <p>原本是高端音响的标准，代表最小音量下没有一点电流噪声，最大音量可以和真实场景媲美。与扬声器的大小和材质是否匹配场景相关，即「重硬件轻软件」。因为只要硬件达到 HDR 1000 规格，那么只要调高亮度就可以了；而随便一个中位水平的电视/显示器/手机屏幕亮度都能达到 HDR 400 标准。</p>
            <p>注意高亮度的显示只适合电影和部分游戏场景，在工作学习用途下高亮度极其伤眼。</p>

            <h4>HDR 元数据设置</h4>
            <p>x264/5 皆支持的元数据设置。但因为 HDR 分为硬件标准，软件标准，以及数据标准，所以很乱。为了保证色彩正确，必须参考片源的元数据。如：</p>
            <div class="align-items-center">
                <img src="files/image43.png" alt="Metadata for VUI HDR Info 1" class="img-medium" >
                <p class="text-gray-side">图 1: cll 1000,640. master-display 由 G(13250…) 开头，L(10000000,1) 结尾</p>
                <img src="files/image44.png" alt="Metadata for VUI HDR Info 2" class="img-medium" >
                <p class="text-gray-side">图 2: cll 1655,117/L(40000000,50)/colorprim bt2020/colormatrix bt2020nc/transfer smpte2084</p>
            </div>

            <pre><code><b>--max-cll</b>&lt;最大内容光强，最大平均光强&gt;压制HDR源一定照源视频信息设，找不到不要用，见上图例
<b>--colorprim</b>&lt;字符&gt;播放用三原色(以及白点)指标，查看视频信息可知：bt470m，bt470bg，smpte170m，smpte240m，film，bt2020，smpte428，smpte431，smpte432。如图1为 bt.2020
<b>--colormatrix</b>&lt;字符&gt;播放用矩阵格式/系数指标：fcc，bt470bg，smpte170m，smpte240m，GBR，YCgCo，bt2020nc，bt2020c， smpte2085，chroma-derived-nc，chroma-derived-c，ICtCp，不支持bt2020nc
<b>--transfer</b>&lt;字符&gt;传输特质: bt470m，bt470bg，smpte170m，smpte240m，linear，log100，log316，iec61966-2-4，bt1361e，iec61966-2-1，bt2020-10，bt2020-12，smpte2084，smpte428，arib-std-b67，上图图2的PQ即st.2084的标准，所以参数值为smpte2084
<b>--master-display</b>&lt;G(x,y)B(,)R(,)WP(,)L(,)&gt;写进SEI信息里，告诉解码端色彩空间/色域信息用
    · 搞得这么麻烦是因为HDR标准设立时还没有HDR电视，所以就把master-display写成必须参数了，而最重要的信息反而是cll。
    · 绿蓝红GBR和白点WP指马蹄形色域的三角+白点4个位置的值×50000
    · 光强L的单位是candela×10000
    · SDR视频的L是1000,1. 压HDR视频前一定要看视频信息再设L，见上图
        · DCI-P3电影业内:	G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(?,1)
        · bt709:			G(15000,30000)B(7500,3000)R(32000,16500)WP(15635,16450)L(?,1)
        · bt2020超清:		G(8500,39850)B(6550,2300)R(35400,14600)WP(15635,16450)L(?,1)
    · RGB原信息(对照小数格式的视频信息, 然后选择上面对应的参数):
        · DCI-P3:	G(x0.265, y0.690), B(x0.150, y0.060), R(x0.680, y0.320), WP(x0.3127, y0.329)
        · bt709:	G(x0.30, y0.60), B(x0.150, y0.060), R(x0.640, y0.330), WP(x0.3127,y0.329)
        · bt2020:	G(x0.170, y0.797), B(x0.131, y0.046), R(x0.708, y0.292), WP(x0.3127,y0.329)
<b>--display-window</b>&lt;←,↑,→,↓&gt;指定黑边宽度，从而跳过加速编码，或者用--overscan crop直接裁掉</code></pre>

            <h2>输入输出 Input-output IO</h2>

            <h2>下载，附录，操作</h2>
        </div>

        <!-- Footer -->
        <footer class="py-3 my-4 align-items-center border-top">
            <p>
                联系方式：
                <a href='https://github.com/iAvoe/'>Github</a>，
                <a href='https://jq.qq.com/?_wv=1027&k=5YJFXyf'>QQ 群：691892901</a>
            </p>
            &#x24B8; iAvoe，2024
        </footer>
        
	</body>
</html>